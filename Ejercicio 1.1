"""
EJERCICIO 1.1: GESTION DE MATERIALES BIBLIOGRAFICOS
"""

import json
import os

class MaterialBibliografico:
    def __init__(self, titulo, autor, a√±o_publicacion, codigo_unico):
        self.__titulo = titulo
        self.__autor = autor
        self.__a√±o_publicacion = a√±o_publicacion
        self.__codigo_unico = codigo_unico
    
    def get_titulo(self): return self.__titulo
    def set_titulo(self, valor):
        if not valor.strip(): raise ValueError("T√≠tulo vac√≠o")
        self.__titulo = valor
    
    def get_autor(self): return self.__autor
    def set_autor(self, valor):
        if not valor.strip(): raise ValueError("Autor vac√≠o")
        self.__autor = valor
    
    def get_a√±o_publicacion(self): return self.__a√±o_publicacion
    def set_a√±o_publicacion(self, valor):
        if not isinstance(valor, int) or valor < 0: raise ValueError("A√±o inv√°lido")
        self.__a√±o_publicacion = valor
    
    def get_codigo_unico(self): return self.__codigo_unico
    def set_codigo_unico(self, valor):
        if not valor.strip(): raise ValueError("C√≥digo vac√≠o")
        self.__codigo_unico = valor
    
    def calcular_valor_prestamo(self, dias): raise NotImplementedError("Abstracto")
    def obtener_tipo_material(self): raise NotImplementedError("Abstracto")
    
    def to_dict(self):
        return {
            'titulo': self.get_titulo(),
            'autor': self.get_autor(),
            'a√±o_publicacion': self.get_a√±o_publicacion(),
            'codigo_unico': self.get_codigo_unico(),
            'tipo': self.obtener_tipo_material()
        }
    
    def __str__(self): return f"{self.get_codigo_unico()} - {self.get_titulo()} ({self.get_a√±o_publicacion()})"

class LibroFisico(MaterialBibliografico):
    def __init__(self, titulo, autor, a√±o, codigo, paginas, editorial, estado):
        super().__init__(titulo, autor, a√±o, codigo)
        self.__num_paginas = paginas
        self.__editorial = editorial
        self.__estado_fisico = estado
    
    def calcular_valor_prestamo(self, dias):
        if dias <= 0: raise ValueError("D√≠as inv√°lidos")
        return 2.00 * dias
    
    def obtener_tipo_material(self): return "Libro F√≠sico"
    
    def to_dict(self):
        data = super().to_dict()
        data.update({'num_paginas': self.__num_paginas, 'editorial': self.__editorial, 'estado_fisico': self.__estado_fisico})
        return data
    
    def __str__(self): return f"{super().__str__()} | P√°ginas: {self.__num_paginas}"

class LibroElectronico(MaterialBibliografico):
    def __init__(self, titulo, autor, a√±o, codigo, tama√±o, formato, url):
        super().__init__(titulo, autor, a√±o, codigo)
        self.__tama√±o_mb = tama√±o
        self.__formato = formato
        self.__url_descarga = url
    
    def calcular_valor_prestamo(self, dias):
        if dias <= 0: raise ValueError("D√≠as inv√°lidos")
        return 1.00 * dias
    
    def obtener_tipo_material(self): return "Libro Electr√≥nico"
    
    def to_dict(self):
        data = super().to_dict()
        data.update({'tama√±o_mb': self.__tama√±o_mb, 'formato': self.__formato, 'url_descarga': self.__url_descarga})
        return data
    
    def __str__(self): return f"{super().__str__()} | Formato: {self.__formato}"

class Revista(MaterialBibliografico):
    def __init__(self, titulo, autor, a√±o, codigo, edicion, mes):
        super().__init__(titulo, autor, a√±o, codigo)
        self.__numero_edicion = edicion
        self.__mes_publicacion = mes
    
    def calcular_valor_prestamo(self, dias):
        if dias <= 0: raise ValueError("D√≠as inv√°lidos")
        return 0.50 * dias
    
    def obtener_tipo_material(self): return "Revista"
    
    def to_dict(self):
        data = super().to_dict()
        data.update({'numero_edicion': self.__numero_edicion, 'mes_publicacion': self.__mes_publicacion})
        return data
    
    def __str__(self): return f"{super().__str__()} | Edici√≥n: {self.__numero_edicion}"

class Audiolibro(MaterialBibliografico):
    def __init__(self, titulo, autor, a√±o, codigo, duracion, narrador, formato):
        super().__init__(titulo, autor, a√±o, codigo)
        self.__duracion_minutos = duracion
        self.__narrador = narrador
        self.__formato_audio = formato
    
    def calcular_valor_prestamo(self, dias):
        if dias <= 0: raise ValueError("D√≠as inv√°lidos")
        return 1.50 * dias
    
    def obtener_tipo_material(self): return "Audiolibro"
    
    def to_dict(self):
        data = super().to_dict()
        data.update({'duracion_minutos': self.__duracion_minutos, 'narrador': self.__narrador, 'formato_audio': self.__formato_audio})
        return data
    
    def __str__(self): return f"{super().__str__()} | Duraci√≥n: {self.__duracion_minutos}min"

class JSONStorage:
    def __init__(self, file_path="data_materiales.json"): self.file_path = file_path
    
    def load_materiales(self):
        if not os.path.exists(self.file_path): return []
        try:
            with open(self.file_path, 'r', encoding='utf-8') as file:
                data = json.load(file)
                materiales = []
                for item in data:
                    tipo = item['tipo']
                    if tipo == "Libro F√≠sico":
                        m = LibroFisico(item['titulo'], item['autor'], item['a√±o_publicacion'], item['codigo_unico'], item['num_paginas'], item['editorial'], item['estado_fisico'])
                    elif tipo == "Libro Electr√≥nico":
                        m = LibroElectronico(item['titulo'], item['autor'], item['a√±o_publicacion'], item['codigo_unico'], item['tama√±o_mb'], item['formato'], item['url_descarga'])
                    elif tipo == "Revista":
                        m = Revista(item['titulo'], item['autor'], item['a√±o_publicacion'], item['codigo_unico'], item['numero_edicion'], item['mes_publicacion'])
                    elif tipo == "Audiolibro":
                        m = Audiolibro(item['titulo'], item['autor'], item['a√±o_publicacion'], item['codigo_unico'], item['duracion_minutos'], item['narrador'], item['formato_audio'])
                    else: continue
                    materiales.append(m)
                print(f"üìÇ Cargados {len(materiales)} materiales")
                return materiales
        except: return []
    
    def save_materiales(self, materiales):
        try:
            data = [m.to_dict() for m in materiales]
            with open(self.file_path, 'w', encoding='utf-8') as file:
                json.dump(data, file, indent=2, ensure_ascii=False)
            print(f"üíæ Guardados {len(materiales)} materiales")
            return True
        except: return False

class MaterialService:
    def __init__(self):
        self.storage = JSONStorage()
        self.materiales = self.storage.load_materiales()
    
    def agregar_libro_fisico(self, titulo, autor, a√±o, paginas, editorial, estado):
        codigo = f"LF{len(self.materiales)+1:03d}"
        libro = LibroFisico(titulo, autor, a√±o, codigo, paginas, editorial, estado)
        self.materiales.append(libro)
        if self.storage.save_materiales(self.materiales):
            print(f"‚úÖ Libro f√≠sico agregado: {codigo}")
            return True
        return False
    
    def agregar_libro_electronico(self, titulo, autor, a√±o, tama√±o, formato, url):
        codigo = f"LE{len(self.materiales)+1:03d}"
        ebook = LibroElectronico(titulo, autor, a√±o, codigo, tama√±o, formato, url)
        self.materiales.append(ebook)
        if self.storage.save_materiales(self.materiales):
            print(f"‚úÖ Libro electr√≥nico agregado: {codigo}")
            return True
        return False
    
    def agregar_revista(self, titulo, autor, a√±o, edicion, mes):
        codigo = f"RV{len(self.materiales)+1:03d}"
        revista = Revista(titulo, autor, a√±o, codigo, edicion, mes)
        self.materiales.append(revista)
        if self.storage.save_materiales(self.materiales):
            print(f"‚úÖ Revista agregada: {codigo}")
            return True
        return False
    
    def agregar_audiolibro(self, titulo, autor, a√±o, duracion, narrador, formato):
        codigo = f"AL{len(self.materiales)+1:03d}"
        audio = Audiolibro(titulo, autor, a√±o, codigo, duracion, narrador, formato)
        self.materiales.append(audio)
        if self.storage.save_materiales(self.materiales):
            print(f"‚úÖ Audiolibro agregado: {codigo}")
            return True
        return False
    
    def obtener_todos(self): return self.materiales
    
    def buscar_por_codigo(self, codigo):
        for m in self.materiales:
            if m.get_codigo_unico() == codigo: return m
        return None
    
    def calcular_prestamo(self, codigo, dias):
        material = self.buscar_por_codigo(codigo)
        if material: return material.calcular_valor_prestamo(dias)
        return None

class MaterialMenu:
    def __init__(self): self.service = MaterialService()
    
    def mostrar_menu(self):
        print("\n" + "="*50)
        print("üìö SISTEMA DE MATERIALES BIBLIOGR√ÅFICOS")
        print("="*50)
        print("1. Ver todos los materiales")
        print("2. Agregar nuevo material")
        print("3. Buscar material por c√≥digo")
        print("4. Calcular valor de pr√©stamo")
        print("5. Demostrar polimorfismo")
        print("6. Demostrar encapsulamiento")
        print("7. Verificar clase abstracta")
        print("0. Salir")
        print("-"*50)
    
    def get_input(self, prompt, tipo=str):
        while True:
            try:
                valor = input(prompt).strip()
                if tipo == int: return int(valor)
                return valor
            except: print("‚ùå Valor inv√°lido")
    
    def ver_todos(self):
        materiales = self.service.obtener_todos()
        if not materiales: print("‚ùå No hay materiales"); return
        print("\nüìã MATERIALES:")
        for m in materiales: print(f"  {m}")
        print(f"üìä Total: {len(materiales)}")
    
    def agregar_material(self):
        print("\nüìù TIPO DE MATERIAL:")
        print("1. Libro F√≠sico")
        print("2. Libro Electr√≥nico")
        print("3. Revista")
        print("4. Audiolibro")
        tipo = self.get_input("Opci√≥n: ", int)
        titulo = self.get_input("T√≠tulo: ")
        autor = self.get_input("Autor: ")
        a√±o = self.get_input("A√±o: ", int)
        
        if tipo == 1:
            paginas = self.get_input("P√°ginas: ", int)
            editorial = self.get_input("Editorial: ")
            estado = self.get_input("Estado (Excelente/Bueno/Regular/Malo): ")
            self.service.agregar_libro_fisico(titulo, autor, a√±o, paginas, editorial, estado)
        elif tipo == 2:
            tama√±o = self.get_input("Tama√±o MB: ", float)
            formato = self.get_input("Formato (PDF/EPUB/MOBI): ")
            url = self.get_input("URL: ")
            self.service.agregar_libro_electronico(titulo, autor, a√±o, tama√±o, formato, url)
        elif tipo == 3:
            edicion = self.get_input("Edici√≥n: ", int)
            mes = self.get_input("Mes: ")
            self.service.agregar_revista(titulo, autor, a√±o, edicion, mes)
        elif tipo == 4:
            duracion = self.get_input("Duraci√≥n (min): ", int)
            narrador = self.get_input("Narrador: ")
            formato = self.get_input("Formato (MP3/WAV/AAC): ")
            self.service.agregar_audiolibro(titulo, autor, a√±o, duracion, narrador, formato)
        else: print("‚ùå Opci√≥n inv√°lida")
    
    def buscar_material(self):
        codigo = self.get_input("C√≥digo: ")
        material = self.service.buscar_por_codigo(codigo)
        if material:
            print(f"\n‚úÖ Encontrado: {material}")
            print(f"   Tipo: {material.obtener_tipo_material()}")
        else: print("‚ùå No encontrado")
    
    def calcular_prestamo(self):
        codigo = self.get_input("C√≥digo: ")
        dias = self.get_input("D√≠as: ", int)
        valor = self.service.calcular_prestamo(codigo, dias)
        if valor is not None: print(f"üí∞ Valor: ${valor:.2f}")
        else: print("‚ùå Material no encontrado")
    
    def demostrar_polimorfismo(self):
        print("\nüéØ DEMOSTRACI√ìN DE POLIMORFISMO")
        print("-"*40)
        materiales = [
            LibroFisico("Libro 1", "Autor 1", 2020, "LF001", 300, "Editorial A", "Bueno"),
            LibroElectronico("Ebook 1", "Autor 2", 2021, "LE001", 5.2, "PDF", "http://url.com"),
            Revista("Revista 1", "Autor 3", 2023, "RV001", 45, "Enero"),
            Audiolibro("Audio 1", "Autor 4", 2022, "AL001", 120, "Narrador", "MP3")
        ]
        print("üìö Materiales creados:")
        for m in materiales: print(f"  {m.get_titulo()} - {m.obtener_tipo_material()}")
        print("\nüí∞ C√°lculo de pr√©stamos (7 d√≠as):")
        for m in materiales:
            valor = m.calcular_valor_prestamo(7)
            print(f"  {m.obtener_tipo_material():<20} ‚Üí ${valor:.2f}")
        print("\n‚úÖ Polimorfismo demostrado")
    
    def demostrar_encapsulamiento(self):
        print("\nüîí DEMOSTRACI√ìN DE ENCAPSULAMIENTO")
        print("-"*40)
        libro = LibroFisico("Test", "Autor", 2023, "TEST001", 100, "Editorial", "Bueno")
        print("‚úÖ Acceso correcto mediante getters:")
        print(f"  T√≠tulo: {libro.get_titulo()}")
        print(f"  Autor: {libro.get_autor()}")
        print("\n‚úÖ Validaci√≥n en setters:")
        try: libro.set_titulo("")
        except ValueError as e: print(f"  ‚úÖ Correcto: {e}")
        print("\n‚ùå Intentando acceso directo a atributos privados:")
        try: print(f"  libro.__titulo = {libro.__titulo}")
        except AttributeError: print("  ‚úÖ Correcto: No se puede acceder directamente")
    
    def verificar_clase_abstracta(self):
        print("\n‚ö†Ô∏è VERIFICANDO CLASE ABSTRACTA")
        print("-"*40)
        try: material = MaterialBibliografico("Test", "Autor", 2023, "TEST")
        except (TypeError, NotImplementedError) as e: print(f"‚úÖ Correcto: {e}")
    
    def run(self):
        print("üöÄ INICIANDO SISTEMA DE MATERIALES...")
        while True:
            self.mostrar_menu()
            opcion = self.get_input("Opci√≥n: ", str)
            if opcion == "0": print("üëã ¬°Adi√≥s!"); break
            elif opcion == "1": self.ver_todos()
            elif opcion == "2": self.agregar_material()
            elif opcion == "3": self.buscar_material()
            elif opcion == "4": self.calcular_prestamo()
            elif opcion == "5": self.demostrar_polimorfismo()
            elif opcion == "6": self.demostrar_encapsulamiento()
            elif opcion == "7": self.verificar_clase_abstracta()
            else: print("‚ùå Opci√≥n inv√°lida")
            if opcion != "0": input("\n‚èé Presiona Enter...")

menu = MaterialMenu()
menu.run()
