import json
import os
from datetime import datetime

class Usuario:
    def __init__(self, nombre, identificacion, email):
        self.__nombre = nombre
        self.__identificacion = identificacion
        self.__email = email
        self.__fecha_registro = datetime.now().isoformat()
        self._historial_prestamos = []
    
    def get_nombre(self): return self.__nombre
    def set_nombre(self, valor):
        if not valor.strip(): raise ValueError("Nombre vac√≠o")
        self.__nombre = valor
    
    def get_identificacion(self): return self.__identificacion
    def set_identificacion(self, valor):
        if not valor.strip(): raise ValueError("ID vac√≠o")
        self.__identificacion = valor
    
    def get_email(self): return self.__email
    def set_email(self, valor):
        if not '@' in valor: raise ValueError("Email inv√°lido")
        self.__email = valor
    
    def get_fecha_registro(self): return self.__fecha_registro
    
    def obtener_limite_prestamos(self): raise NotImplementedError("Abstracto")
    def calcular_dias_prestamo(self): raise NotImplementedError("Abstracto")
    def obtener_privilegios(self): raise NotImplementedError("Abstracto")
    
    def agregar_prestamo(self, material):
        if not material: raise ValueError("Material vac√≠o")
        if self.__validar_limite_prestamos():
            self._historial_prestamos.append({
                'material': material,
                'fecha': datetime.now().isoformat(),
                'estado': 'activo'
            })
            return True
        return False
    
    def __validar_limite_prestamos(self):
        activos = [p for p in self._historial_prestamos if p['estado'] == 'activo']
        return len(activos) < self.obtener_limite_prestamos()
    
    def get_historial_prestamos(self): return self._historial_prestamos.copy()
    
    def devolver_prestamo(self, material_id):
        for p in self._historial_prestamos:
            if p['material'].get_codigo_unico() == material_id and p['estado'] == 'activo':
                p['estado'] = 'devuelto'
                p['fecha_devolucion'] = datetime.now().isoformat()
                return True
        return False
    
    def generar_reporte(self):
        activos = [p for p in self._historial_prestamos if p['estado'] == 'activo']
        devueltos = [p for p in self._historial_prestamos if p['estado'] == 'devuelto']
        return {
            'nombre': self.__nombre,
            'tipo': self.obtener_privilegios(),
            'total_prestamos': len(self._historial_prestamos),
            'activos': len(activos),
            'devueltos': len(devueltos),
            'limite': self.obtener_limite_prestamos(),
            'dias_prestamo': self.calcular_dias_prestamo()
        }
    
    def to_dict(self):
        return {
            'nombre': self.get_nombre(),
            'identificacion': self.get_identificacion(),
            'email': self.get_email(),
            'fecha_registro': self.get_fecha_registro(),
            'tipo': self.obtener_privilegios(),
            'historial': self._historial_prestamos
        }
    
    def __str__(self): return f"{self.get_identificacion()} - {self.get_nombre()} ({self.obtener_privilegios()})"

class Estudiante(Usuario):
    def __init__(self, nombre, id, email, carrera, semestre):
        super().__init__(nombre, id, email)
        self.__carrera = carrera
        self.__semestre = semestre
    
    def obtener_limite_prestamos(self): return 3
    def calcular_dias_prestamo(self): return 7
    def obtener_privilegios(self): return "Estudiante"
    
    def to_dict(self):
        data = super().to_dict()
        data.update({'carrera': self.__carrera, 'semestre': self.__semestre})
        return data
    
    def __str__(self): return f"{super().__str__()} | Carrera: {self.__carrera}"

class Profesor(Usuario):
    def __init__(self, nombre, id, email, departamento):
        super().__init__(nombre, id, email)
        self.__departamento = departamento
    
    def obtener_limite_prestamos(self): return 5
    def calcular_dias_prestamo(self): return 15
    def obtener_privilegios(self): return "Profesor"
    
    def to_dict(self):
        data = super().to_dict()
        data.update({'departamento': self.__departamento})
        return data
    
    def __str__(self): return f"{super().__str__()} | Depto: {self.__departamento}"

class Investigador(Usuario):
    def __init__(self, nombre, id, email, area):
        super().__init__(nombre, id, email)
        self.__area_investigacion = area
    
    def obtener_limite_prestamos(self): return 10
    def calcular_dias_prestamo(self): return 30
    def obtener_privilegios(self): return "Investigador"
    
    def to_dict(self):
        data = super().to_dict()
        data.update({'area_investigacion': self.__area_investigacion})
        return data
    
    def __str__(self): return f"{super().__str__()} | √Årea: {self.__area_investigacion}"

class UsuarioPublico(Usuario):
    def __init__(self, nombre, id, email):
        super().__init__(nombre, id, email)
    
    def obtener_limite_prestamos(self): return 2
    def calcular_dias_prestamo(self): return 5
    def obtener_privilegios(self): return "Usuario P√∫blico"
    
    def __str__(self): return super().__str__()

class JSONStorage:
    def __init__(self, file_path="data_usuarios.json"): self.file_path = file_path
    
    def load_usuarios(self):
        if not os.path.exists(self.file_path): return []
        try:
            with open(self.file_path, 'r', encoding='utf-8') as file:
                data = json.load(file)
                usuarios = []
                for item in data:
                    tipo = item['tipo']
                    if tipo == "Estudiante":
                        u = Estudiante(item['nombre'], item['identificacion'], item['email'], item['carrera'], item['semestre'])
                    elif tipo == "Profesor":
                        u = Profesor(item['nombre'], item['identificacion'], item['email'], item['departamento'])
                    elif tipo == "Investigador":
                        u = Investigador(item['nombre'], item['identificacion'], item['email'], item['area_investigacion'])
                    elif tipo == "Usuario P√∫blico":
                        u = UsuarioPublico(item['nombre'], item['identificacion'], item['email'])
                    else: continue
                    u._historial_prestamos = item['historial']
                    usuarios.append(u)
                print(f"üìÇ Cargados {len(usuarios)} usuarios")
                return usuarios
        except: return []
    
    def save_usuarios(self, usuarios):
        try:
            data = [u.to_dict() for u in usuarios]
            with open(self.file_path, 'w', encoding='utf-8') as file:
                json.dump(data, file, indent=2, ensure_ascii=False)
            print(f"üíæ Guardados {len(usuarios)} usuarios")
            return True
        except: return False

class UsuarioService:
    def __init__(self):
        self.storage = JSONStorage()
        self.usuarios = self.storage.load_usuarios()
    
    def agregar_estudiante(self, nombre, id, email, carrera, semestre):
        u = Estudiante(nombre, id, email, carrera, semestre)
        self.usuarios.append(u)
        if self.storage.save_usuarios(self.usuarios):
            print(f"‚úÖ Estudiante agregado: {id}")
            return True
        return False
    
    def agregar_profesor(self, nombre, id, email, departamento):
        u = Profesor(nombre, id, email, departamento)
        self.usuarios.append(u)
        if self.storage.save_usuarios(self.usuarios):
            print(f"‚úÖ Profesor agregado: {id}")
            return True
        return False
    
    def agregar_investigador(self, nombre, id, email, area):
        u = Investigador(nombre, id, email, area)
        self.usuarios.append(u)
        if self.storage.save_usuarios(self.usuarios):
            print(f"‚úÖ Investigador agregado: {id}")
            return True
        return False
    
    def agregar_publico(self, nombre, id, email):
        u = UsuarioPublico(nombre, id, email)
        self.usuarios.append(u)
        if self.storage.save_usuarios(self.usuarios):
            print(f"‚úÖ Usuario p√∫blico agregado: {id}")
            return True
        return False
    
    def obtener_todos(self): return self.usuarios
    
    def buscar_por_id(self, id):
        for u in self.usuarios:
            if u.get_identificacion() == id: return u
        return None
    
    def puede_solicitar(self, id):
        usuario = self.buscar_por_id(id)
        if not usuario: return False, "Usuario no encontrado"
        activos = len([p for p in usuario.get_historial_prestamos() if p['estado'] == 'activo'])
        limite = usuario.obtener_limite_prestamos()
        if activos >= limite: return False, f"L√≠mite alcanzado ({activos}/{limite})"
        return True, f"Puede solicitar ({activos}/{limite})"
    
    def prestar_material(self, id, material):
        usuario = self.buscar_por_id(id)
        if not usuario: return False, "Usuario no encontrado"
        puede, mensaje = self.puede_solicitar(id)
        if not puede: return False, mensaje
        if usuario.agregar_prestamo(material):
            if self.storage.save_usuarios(self.usuarios):
                return True, f"Pr√©stamo exitoso ({usuario.calcular_dias_prestamo()} d√≠as)"
        return False, "Error al agregar pr√©stamo"

class MaterialSimulado:
    def __init__(self, codigo, titulo):
        self.__codigo = codigo
        self.__titulo = titulo
    def get_codigo_unico(self): return self.__codigo
    def get_titulo(self): return self.__titulo
    def __str__(self): return f"{self.__codigo} - {self.__titulo}"

class UsuarioMenu:
    def __init__(self):
        self.service = UsuarioService()
        self.materiales = [
            MaterialSimulado("LF001", "Cien A√±os de Soledad"),
            MaterialSimulado("LE001", "Python Crash Course"),
            MaterialSimulado("RV001", "National Geographic"),
            MaterialSimulado("AL001", "1984 Audiolibro")
        ]
    
    def mostrar_menu(self):
        print("\n" + "="*50)
        print("üë• SISTEMA DE USUARIOS Y MEMBRES√çAS")
        print("="*50)
        print("1. Ver todos los usuarios")
        print("2. Agregar nuevo usuario")
        print("3. Buscar usuario por ID")
        print("4. Realizar pr√©stamo")
        print("5. Ver privilegios")
        print("6. Demostrar polimorfismo")
        print("7. Demostrar encapsulamiento")
        print("8. Verificar clase abstracta")
        print("0. Salir")
        print("-"*50)
    
    def get_input(self, prompt, tipo=str):
        while True:
            try:
                valor = input(prompt).strip()
                if tipo == int: return int(valor)
                return valor
            except: print("‚ùå Valor inv√°lido")
    
    def ver_todos(self):
        usuarios = self.service.obtener_todos()
        if not usuarios: print("‚ùå No hay usuarios"); return
        print("\nüìã USUARIOS:")
        for u in usuarios: print(f"  {u}")
        print(f"üìä Total: {len(usuarios)}")
    
    def agregar_usuario(self):
        print("\nüìù TIPO DE USUARIO:")
        print("1. Estudiante")
        print("2. Profesor")
        print("3. Investigador")
        print("4. Usuario P√∫blico")
        tipo = self.get_input("Opci√≥n: ", int)
        nombre = self.get_input("Nombre: ")
        id = self.get_input("Identificaci√≥n: ")
        email = self.get_input("Email: ")
        
        if tipo == 1:
            carrera = self.get_input("Carrera: ")
            semestre = self.get_input("Semestre: ", int)
            self.service.agregar_estudiante(nombre, id, email, carrera, semestre)
        elif tipo == 2:
            depto = self.get_input("Departamento: ")
            self.service.agregar_profesor(nombre, id, email, depto)
        elif tipo == 3:
            area = self.get_input("√Årea investigaci√≥n: ")
            self.service.agregar_investigador(nombre, id, email, area)
        elif tipo == 4:
            self.service.agregar_publico(nombre, id, email)
        else: print("‚ùå Opci√≥n inv√°lida")
    
    def buscar_usuario(self):
        id = self.get_input("ID: ")
        usuario = self.service.buscar_por_id(id)
        if usuario:
            print(f"\n‚úÖ Encontrado: {usuario}")
            print(f"   L√≠mite: {usuario.obtener_limite_prestamos()} libros")
            print(f"   D√≠as: {usuario.calcular_dias_prestamo()} d√≠as")
        else: print("‚ùå No encontrado")
    
    def realizar_prestamo(self):
        id = self.get_input("ID usuario: ")
        usuario = self.service.buscar_por_id(id)
        if not usuario: print("‚ùå Usuario no encontrado"); return
        
        puede, mensaje = self.service.puede_solicitar(id)
        print(f"\nüë§ {usuario.get_nombre()}")
        print(f"üìä Estado: {mensaje}")
        
        if not puede: print("‚ùå No puede solicitar m√°s pr√©stamos"); return
        
        print("\nüìö Materiales disponibles:")
        for i, m in enumerate(self.materiales, 1):
            print(f"  {i}. {m}")
        
        try:
            opc = self.get_input("Seleccione material (n√∫mero): ", int)
            if 1 <= opc <= len(self.materiales):
                material = self.materiales[opc-1]
                exito, msg = self.service.prestar_material(id, material)
                if exito: print(f"‚úÖ {msg}")
                else: print(f"‚ùå {msg}")
            else: print("‚ùå Opci√≥n inv√°lida")
        except: print("‚ùå Error")
    
    def ver_privilegios(self):
        id = self.get_input("ID usuario: ")
        usuario = self.service.buscar_por_id(id)
        if not usuario: print("‚ùå No encontrado"); return
        
        print(f"\nüëë PRIVILEGIOS DE {usuario.get_nombre().upper()}:")
        print(f"  Tipo: {usuario.obtener_privilegios()}")
        print(f"  L√≠mite pr√©stamos: {usuario.obtener_limite_prestamos()}")
        print(f"  D√≠as por pr√©stamo: {usuario.calcular_dias_prestamo()}")
        
        reporte = usuario.generar_reporte()
        print(f"  Pr√©stamos activos: {reporte['activos']}/{reporte['limite']}")
    
    def demostrar_polimorfismo(self):
        print("\nüéØ DEMOSTRACI√ìN DE POLIMORFISMO")
        print("-"*40)
        usuarios = [
            Estudiante("Ana", "E001", "ana@edu.com", "Ingenier√≠a", 5),
            Profesor("Dr. Mart√≠nez", "P001", "martinez@edu.com", "Matem√°ticas"),
            Investigador("Dr. Rodr√≠guez", "I001", "rodriguez@lab.com", "Biolog√≠a"),
            UsuarioPublico("Juan", "U001", "juan@email.com")
        ]
        
        print("üë• Usuarios creados:")
        for u in usuarios: print(f"  {u}")
        
        print("\nüìä L√≠mites y privilegios:")
        for u in usuarios:
            print(f"  {u.obtener_privilegios():<20} ‚Üí {u.obtener_limite_prestamos():2} libros, {u.calcular_dias_prestamo():2} d√≠as")
        
        print("\n‚úÖ Polimorfismo demostrado")
    
    def demostrar_encapsulamiento(self):
        print("\nüîí DEMOSTRACI√ìN DE ENCAPSULAMIENTO")
        print("-"*40)
        usuario = Estudiante("Test", "TEST", "test@test.com", "Test", 1)
        
        print("‚úÖ Acceso mediante getters:")
        print(f"  Nombre: {usuario.get_nombre()}")
        print(f"  Email: {usuario.get_email()}")
        
        print("\n‚úÖ Validaci√≥n en setters:")
        try: usuario.set_email("emailinvalido")
        except ValueError as e: print(f"  ‚úÖ Correcto: {e}")
        
        print("\n‚ùå Intentando acceso directo:")
        try: print(f"  usuario.__nombre = {usuario.__nombre}")
        except AttributeError: print("  ‚úÖ Correcto: No se puede acceder directamente")
    
    def verificar_clase_abstracta(self):
        print("\n‚ö†Ô∏è VERIFICANDO CLASE ABSTRACTA")
        print("-"*40)
        try: usuario = Usuario("Test", "TEST", "test@test.com")
        except (TypeError, NotImplementedError) as e: print(f"‚úÖ Correcto: {e}")
    
    def run(self):
        print("üöÄ INICIANDO SISTEMA DE USUARIOS...")
        while True:
            self.mostrar_menu()
            opcion = self.get_input("Opci√≥n: ", str)
            if opcion == "0": print("üëã ¬°Adi√≥s!"); break
            elif opcion == "1": self.ver_todos()
            elif opcion == "2": self.agregar_usuario()
            elif opcion == "3": self.buscar_usuario()
            elif opcion == "4": self.realizar_prestamo()
            elif opcion == "5": self.ver_privilegios()
            elif opcion == "6": self.demostrar_polimorfismo()
            elif opcion == "7": self.demostrar_encapsulamiento()
            elif opcion == "8": self.verificar_clase_abstracta()
            else: print("‚ùå Opci√≥n inv√°lida")
            if opcion != "0": input("\n‚èé Presiona Enter...")

menu = UsuarioMenu()
menu.run()
