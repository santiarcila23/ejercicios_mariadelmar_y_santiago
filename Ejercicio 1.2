"""
EJERCICIO 1.2: SISTEMA DE USUARIOS Y MEMBRES√çAS
"""

from datetime import datetime

class Usuario:
    def __init__(self, nombre, identificacion, email):
        self.__nombre = nombre
        self.__identificacion = identificacion
        self.__email = email
        self.__fecha_registro = datetime.now()
        self._historial_prestamos = []
    
    def get_nombre(self):
        return self.__nombre
    
    def set_nombre(self, nombre):
        if not nombre or not isinstance(nombre, str):
            raise ValueError("Nombre inv√°lido")
        self.__nombre = nombre
    
    def get_identificacion(self):
        return self.__identificacion
    
    def set_identificacion(self, identificacion):
        if not identificacion or not isinstance(identificacion, str):
            raise ValueError("Identificaci√≥n inv√°lida")
        self.__identificacion = identificacion
    
    def get_email(self):
        return self.__email
    
    def set_email(self, email):
        if not email or "@" not in email:
            raise ValueError("Email inv√°lido")
        self.__email = email
    
    def get_fecha_registro(self):
        return self.__fecha_registro
    
    def agregar_prestamo(self, material):
        if self._validar_limite_prestamos():
            prestamo = {
                'material': material,
                'fecha': datetime.now(),
                'devuelto': False
            }
            self._historial_prestamos.append(prestamo)
            return True
        return False
    
    def _validar_limite_prestamos(self):
        activos = 0
        for prestamo in self._historial_prestamos:
            if not prestamo['devuelto']:
                activos += 1
        return activos < self.obtener_limite_prestamos()
    
    def obtener_limite_prestamos(self):
        raise NotImplementedError("M√©todo debe implementarse")
    
    def calcular_dias_prestamo(self):
        raise NotImplementedError("M√©todo debe implementarse")
    
    def obtener_privilegios(self):
        raise NotImplementedError("M√©todo debe implementarse")
    
    def generar_reporte(self):
        activos = 0
        for prestamo in self._historial_prestamos:
            if not prestamo['devuelto']:
                activos += 1
        
        return {
            'nombre': self.__nombre,
            'tipo': self.__class__.__name__,
            'limite_prestamos': self.obtener_limite_prestamos(),
            'dias_prestamo': self.calcular_dias_prestamo(),
            'prestamos_activos': activos,
            'total_prestamos': len(self._historial_prestamos),
            'privilegios': self.obtener_privilegios()
        }
    
    def get_historial_prestamos(self):
        return self._historial_prestamos.copy()
    
    def __str__(self):
        return f"{self.__class__.__name__}: {self.__nombre}"

class Estudiante(Usuario):
    def __init__(self, nombre, identificacion, email, carrera, semestre):
        super().__init__(nombre, identificacion, email)
        self.__carrera = carrera
        self.__semestre = semestre
    
    def obtener_limite_prestamos(self):
        return 3
    
    def calcular_dias_prestamo(self):
        return 7
    
    def obtener_privilegios(self):
        return ["Acceso a sala de estudio", "Pr√©stamo interbibliotecario", "Renovaci√≥n online 1 vez"]
    
    def get_carrera(self):
        return self.__carrera
    
    def set_carrera(self, carrera):
        if not carrera or not isinstance(carrera, str):
            raise ValueError("Carrera inv√°lida")
        self.__carrera = carrera
    
    def get_semestre(self):
        return self.__semestre
    
    def set_semestre(self, semestre):
        if not isinstance(semestre, int) or semestre < 1 or semestre > 12:
            raise ValueError("Semestre inv√°lido")
        self.__semestre = semestre
    
    def __str__(self):
        return f"{super().__str__()} | Carrera: {self.__carrera} (Sem {self.__semestre})"

class Profesor(Usuario):
    def __init__(self, nombre, identificacion, email, departamento):
        super().__init__(nombre, identificacion, email)
        self.__departamento = departamento
    
    def obtener_limite_prestamos(self):
        return 5
    
    def calcular_dias_prestamo(self):
        return 15
    
    def obtener_privilegios(self):
        return ["Pr√©stamo extendido", "Acceso a recursos especiales", 
                "Renovaci√≥n autom√°tica", "Solicitud de adquisiciones"]
    
    def get_departamento(self):
        return self.__departamento
    
    def set_departamento(self, departamento):
        if not departamento or not isinstance(departamento, str):
            raise ValueError("Departamento inv√°lido")
        self.__departamento = departamento
    
    def __str__(self):
        return f"{super().__str__()} | Depto: {self.__departamento}"

class Investigador(Usuario):
    def __init__(self, nombre, identificacion, email, area_investigacion):
        super().__init__(nombre, identificacion, email)
        self.__area_investigacion = area_investigacion
    
    def obtener_limite_prestamos(self):
        return 10
    
    def calcular_dias_prestamo(self):
        return 30
    
    def obtener_privilegios(self):
        return ["Pr√©stamo ilimitado virtual", "Acceso a bases de datos premium", 
                "Renovaci√≥n autom√°tica x3", "Pr√©stamo internacional"]
    
    def get_area_investigacion(self):
        return self.__area_investigacion
    
    def set_area_investigacion(self, area):
        if not area or not isinstance(area, str):
            raise ValueError("√Årea de investigaci√≥n inv√°lida")
        self.__area_investigacion = area
    
    def __str__(self):
        return f"{super().__str__()} | √Årea: {self.__area_investigacion}"

class UsuarioPublico(Usuario):
    def __init__(self, nombre, identificacion, email):
        super().__init__(nombre, identificacion, email)
    
    def obtener_limite_prestamos(self):
        return 2
    
    def calcular_dias_prestamo(self):
        return 5
    
    def obtener_privilegios(self):
        return ["Acceso a sala de lectura", "Consulta en sala"]
    
    def __str__(self):
        return super().__str__()

# ========== MEN√ö INTERACTIVO ==========
class MenuUsuarios:
    def __init__(self):
        self.usuarios = []
        self.cargar_datos_ejemplo()
    
    def cargar_datos_ejemplo(self):
        """Carga datos de ejemplo para probar"""
        self.usuarios.append(
            Estudiante("Ana L√≥pez", "EST001", "ana@universidad.edu", 
                      "Ingenier√≠a de Sistemas", 5)
        )
        self.usuarios.append(
            Estudiante("Carlos Ruiz", "EST002", "carlos@universidad.edu", 
                      "Medicina", 8)
        )
        self.usuarios.append(
            Profesor("Dr. Mart√≠nez", "PROF001", "martinez@universidad.edu", 
                    "Matem√°ticas")
        )
        self.usuarios.append(
            Profesor("Dra. G√≥mez", "PROF002", "gomez@universidad.edu", 
                    "Literatura")
        )
        self.usuarios.append(
            Investigador("Dr. Rodr√≠guez", "INV001", "rodriguez@instituto.edu", 
                        "Inteligencia Artificial")
        )
        self.usuarios.append(
            UsuarioPublico("Juan Torres", "PUB001", "juan@email.com")
        )
    
    def mostrar_menu_principal(self):
        print("\n" + "="*60)
        print("üë• SISTEMA DE GESTI√ìN DE USUARIOS")
        print("="*60)
        print("1. üë§ Crear nuevo usuario")
        print("2. üëÄ Ver todos los usuarios")
        print("3. üîç Buscar usuario por ID")
        print("4. üìã Ver reporte de usuario")
        print("5. üìö Simular pr√©stamo")
        print("6. üéØ Demostrar polimorfismo")
        print("7. üîí Demostrar encapsulamiento")
        print("8. üìä Estad√≠sticas del sistema")
        print("0. üö™ Salir")
        print("-"*60)
    
    def mostrar_menu_creacion(self):
        print("\n" + "="*40)
        print("üë§ CREAR NUEVO USUARIO")
        print("="*40)
        print("1. Estudiante")
        print("2. Profesor")
        print("3. Investigador")
        print("4. Usuario P√∫blico")
        print("0. Volver")
        print("-"*40)
    
    def obtener_entrada(self, mensaje, tipo=str):
        while True:
            try:
                entrada = input(f"{mensaje}: ").strip()
                if tipo == int:
                    return int(entrada)
                elif tipo == float:
                    return float(entrada)
                return entrada
            except ValueError:
                print("‚ùå Entrada inv√°lida. Intente nuevamente.")
    
    def crear_estudiante(self):
        print("\n--- CREAR ESTUDIANTE ---")
        nombre = self.obtener_entrada("Nombre completo")
        identificacion = self.obtener_entrada("Identificaci√≥n")
        email = self.obtener_entrada("Email")
        carrera = self.obtener_entrada("Carrera")
        semestre = self.obtener_entrada("Semestre", int)
        
        try:
            estudiante = Estudiante(nombre, identificacion, email, carrera, semestre)
            self.usuarios.append(estudiante)
            print(f"‚úÖ Estudiante '{nombre}' creado exitosamente!")
        except ValueError as e:
            print(f"‚ùå Error: {e}")
    
    def crear_profesor(self):
        print("\n--- CREAR PROFESOR ---")
        nombre = self.obtener_entrada("Nombre completo")
        identificacion = self.obtener_entrada("Identificaci√≥n")
        email = self.obtener_entrada("Email")
        departamento = self.obtener_entrada("Departamento")
        
        try:
            profesor = Profesor(nombre, identificacion, email, departamento)
            self.usuarios.append(profesor)
            print(f"‚úÖ Profesor '{nombre}' creado exitosamente!")
        except ValueError as e:
            print(f"‚ùå Error: {e}")
    
    def crear_investigador(self):
        print("\n--- CREAR INVESTIGADOR ---")
        nombre = self.obtener_entrada("Nombre completo")
        identificacion = self.obtener_entrada("Identificaci√≥n")
        email = self.obtener_entrada("Email")
        area = self.obtener_entrada("√Årea de investigaci√≥n")
        
        try:
            investigador = Investigador(nombre, identificacion, email, area)
            self.usuarios.append(investigador)
            print(f"‚úÖ Investigador '{nombre}' creado exitosamente!")
        except ValueError as e:
            print(f"‚ùå Error: {e}")
    
    def crear_usuario_publico(self):
        print("\n--- CREAR USUARIO P√öBLICO ---")
        nombre = self.obtener_entrada("Nombre completo")
        identificacion = self.obtener_entrada("Identificaci√≥n")
        email = self.obtener_entrada("Email")
        
        try:
            usuario = UsuarioPublico(nombre, identificacion, email)
            self.usuarios.append(usuario)
            print(f"‚úÖ Usuario p√∫blico '{nombre}' creado exitosamente!")
        except ValueError as e:
            print(f"‚ùå Error: {e}")
    
    def ver_usuarios(self):
        if not self.usuarios:
            print("\nüì≠ No hay usuarios registrados.")
            return
        
        print("\n" + "="*80)
        print("üë• LISTA DE USUARIOS")
        print("="*80)
        for i, usuario in enumerate(self.usuarios, 1):
            print(f"{i}. {usuario}")
        print("-"*80)
        print(f"Total: {len(self.usuarios)} usuarios")
    
    def buscar_por_id(self):
        identificacion = self.obtener_entrada("\nüîç Ingrese identificaci√≥n a buscar")
        
        for usuario in self.usuarios:
            if usuario.get_identificacion() == identificacion:
                print("\n‚úÖ USUARIO ENCONTRADO:")
                print(usuario)
                return
        
        print(f"‚ùå No se encontr√≥ usuario con ID: {identificacion}")
    
    def ver_reporte_usuario(self):
        if not self.usuarios:
            print("\nüì≠ No hay usuarios para reportes.")
            return
        
        self.ver_usuarios()
        try:
            opcion = self.obtener_entrada("\nüìã Ingrese n√∫mero de usuario para reporte", int) - 1
            if 0 <= opcion < len(self.usuarios):
                usuario = self.usuarios[opcion]
                reporte = usuario.generar_reporte()
                
                print("\n" + "="*60)
                print(f"üìÑ REPORTE DE {usuario.get_nombre().upper()}")
                print("="*60)
                for clave, valor in reporte.items():
                    if clave == 'privilegios':
                        print(f"\n{clgue.replace('_', ' ').title()}:")
                        for privilegio in valor:
                            print(f"  ‚Ä¢ {privilegio}")
                    else:
                        print(f"{clave.replace('_', ' ').title()}: {valor}")
        except (ValueError, IndexError):
            print("‚ùå Opci√≥n inv√°lida")
    
    def simular_prestamo(self):
        if not self.usuarios:
            print("\nüì≠ No hay usuarios para pr√©stamos.")
            return
        
        # Importar Material de ejemplo del Ejercicio 1.1
        try:
            from ejercicio_1_1_menu import LibroFisico
            libro = LibroFisico("Libro de Pr√©stamo", "Autor", 2023, 
                               "TEST001", 200, "Editorial", "bueno")
        except ImportError:
            print("‚ö†Ô∏è  No se pudo importar MaterialBibliografico")
            print("   Ejecute primero el Ejercicio 1.1 o cree un material manual")
            return
        
        self.ver_usuarios()
        try:
            opcion = self.obtener_entrada("\nüìö Seleccione usuario para pr√©stamo", int) - 1
            if 0 <= opcion < len(self.usuarios):
                usuario = self.usuarios[opcion]
                
                print(f"\nüíº Usuario seleccionado: {usuario.get_nombre()}")
                print(f"   L√≠mite de pr√©stamos: {usuario.obtener_limite_prestamos()}")
                print(f"   D√≠as de pr√©stamo: {usuario.calcular_dias_prestamo()}")
                
                # Intentar hacer pr√©stamo
                if usuario.agregar_prestamo(libro):
                    print(f"‚úÖ Pr√©stamo exitoso!")
                    print(f"   Material: {libro.get_titulo()}")
                    
                    # Verificar l√≠mite
                    for i in range(usuario.obtener_limite_prestamos()):
                        if not usuario.agregar_prestamo(libro):
                            print(f"‚ùå L√≠mite alcanzado en pr√©stamo {i+2}")
                            break
                else:
                    print("‚ùå No se pudo realizar el pr√©stamo")
                    
        except (ValueError, IndexError):
            print("‚ùå Opci√≥n inv√°lida")
    
    def demostrar_polimorfismo(self):
        if not self.usuarios:
            print("\nüì≠ No hay usuarios para demostrar.")
            return
        
        print("\n" + "="*60)
        print("üéØ DEMOSTRACI√ìN DE POLIMORFISMO")
        print("="*60)
        print("Mismo m√©todo obtener_privilegios(), diferentes resultados:")
        print("-"*60)
        
        for usuario in self.usuarios:
            privilegios = usuario.obtener_privilegios()
            print(f"\n{usuario.__class__.__name__}:")
            for p in privilegios[:3]:  # Mostrar solo 3 privilegios
                print(f"  ‚Ä¢ {p}")
            if len(privilegios) > 3:
                print(f"  ‚Ä¢ ... y {len(privilegios)-3} m√°s")
        
        print("\n" + "-"*60)
        print("Mismo m√©todo generar_reporte(), estructura diferente:")
        print("-"*60)
        
        for usuario in self.usuarios[:2]:  # Mostrar solo 2 ejemplos
            reporte = usuario.generar_reporte()
            print(f"\n{usuario.__class__.__name__}:")
            print(f"  L√≠mite: {reporte['limite_prestamos']} | D√≠as: {reporte['dias_prestamo']}")
    
    def demostrar_encapsulamiento(self):
        print("\n" + "="*60)
        print("üîí DEMOSTRACI√ìN DE ENCAPSULAMIENTO")
        print("="*60)
        
        if not self.usuarios:
            print("‚ùå No hay usuarios para demostrar")
            return
        
        usuario = self.usuarios[0]
        
        print("1. Intentando acceder a atributos privados directamente:")
        print("   usuario.__nombre ‚Üí Generar√° AttributeError")
        
        try:
            print(f"   Intento: {usuario.__nombre}")
        except AttributeError:
            print("   ‚úÖ CORRECTO: AttributeError al acceder a __nombre")
        
        print("\n2. Usando getters y setters con validaci√≥n:")
        print(f"   Email actual: {usuario.get_email()}")
        
        # Intentar asignar email inv√°lido
        try:
            usuario.set_email("email-invalido")
        except ValueError as e:
            print(f"   ‚ùå Setter bloquea email inv√°lido: {e}")
        
        # Asignar email v√°lido
        try:
            usuario.set_email("nuevo@email.com")
            print(f"   ‚úÖ Setter acepta email v√°lido: {usuario.get_email()}")
        except ValueError as e:
            print(f"   ‚ùå Error: {e}")
        
        print("\n3. Historial protegido (solo lectura):")
        historial = usuario.get_historial_prestamos()
        print(f"   Historial obtenido como copia: {len(historial)} pr√©stamos")
        print("   Modificar la copia no afecta el original")
    
    def mostrar_estadisticas(self):
        if not self.usuarios:
            print("\nüì≠ No hay usuarios para estad√≠sticas.")
            return
        
        print("\n" + "="*60)
        print("üìä ESTAD√çSTICAS DEL SISTEMA DE USUARIOS")
        print("="*60)
        
        # Contar por tipo
        tipos = {}
        total_prestamos = 0
        
        for usuario in self.usuarios:
            tipo = usuario.__class__.__name__
            tipos[tipo] = tipos.get(tipo, 0) + 1
            total_prestamos += len(usuario.get_historial_prestamos())
        
        print("üìà Distribuci√≥n por tipo de usuario:")
        for tipo, cantidad in tipos.items():
            print(f"   {tipo}: {cantidad} usuarios")
        
        print(f"\nüë• Total de usuarios: {len(self.usuarios)}")
        print(f"üìö Total de pr√©stamos simulados: {total_prestamos}")
        
        # Calcular promedios
        if self.usuarios:
            promedios = {}
            for tipo in tipos.keys():
                usuarios_tipo = [u for u in self.usuarios if u.__class__.__name__ == tipo]
                if usuarios_tipo:
                    prestamos_tipo = sum(len(u.get_historial_prestamos()) for u in usuarios_tipo)
                    promedios[tipo] = prestamos_tipo / len(usuarios_tipo)
            
            print("\nüìä Promedio de pr√©stamos por usuario:")
            for tipo, promedio in promedios.items():
                print(f"   {tipo}: {promedio:.1f} pr√©stamos/usuario")
    
    def ejecutar(self):
        while True:
            self.mostrar_menu_principal()
            opcion = self.obtener_entrada("Seleccione una opci√≥n", int)
            
            if opcion == 0:
                print("\nüëã ¬°Gracias por usar el sistema de usuarios!")
                break
            
            elif opcion == 1:
                while True:
                    self.mostrar_menu_creacion()
                    sub_opcion = self.obtener_entrada("Seleccione tipo de usuario", int)
                    
                    if sub_opcion == 0:
                        break
                    elif sub_opcion == 1:
                        self.crear_estudiante()
                    elif sub_opcion == 2:
                        self.crear_profesor()
                    elif sub_opcion == 3:
                        self.crear_investigador()
                    elif sub_opcion == 4:
                        self.crear_usuario_publico()
                    else:
                        print("‚ùå Opci√≥n inv√°lida")
            
            elif opcion == 2:
                self.ver_usuarios()
            
            elif opcion == 3:
                self.buscar_por_id()
            
            elif opcion == 4:
                self.ver_reporte_usuario()
            
            elif opcion == 5:
                self.simular_prestamo()
            
            elif opcion == 6:
                self.demostrar_polimorfismo()
            
            elif opcion == 7:
                self.demostrar_encapsulamiento()
            
            elif opcion == 8:
                self.mostrar_estadisticas()
            
            else:
                print("‚ùå Opci√≥n inv√°lida")
            
            if opcion != 0:
                input("\n‚èé Presione Enter para continuar...")

# ========== PROGRAMA PRINCIPAL ==========
if __name__ == "__main__":
    print("="*60)
    print("EJERCICIO 1.2: SISTEMA DE USUARIOS Y MEMBRES√çAS")
    print("="*60)
    
    # Demostrar que no se puede instanciar clase abstracta
    print("\nüîç Demostrando ABSTRACCI√ìN:")
    try:
        # Intentar crear objeto de clase abstracta
        usuario = Usuario("Test", "123", "test@email.com")
        print("‚ùå ERROR: No deber√≠a poder instanciarse")
    except NotImplementedError as e:
        print(f"‚úÖ CORRECTO: No se puede instanciar Usuario base")
        print(f"   Error: {e}")
    
    input("\n‚èé Presione Enter para iniciar el sistema interactivo...")
    
    # Iniciar men√∫ interactivo
    sistema = MenuUsuarios()
    sistema.ejecutar()
