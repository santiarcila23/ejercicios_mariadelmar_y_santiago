"""
EJERCICIO 1.4: SISTEMA DE REPORTES Y ESTAD√çSTICAS
"""

import json
import csv
from datetime import datetime
from io import StringIO

class Reporte:
    def __init__(self, titulo_reporte, generado_por):
        self.__titulo_reporte = titulo_reporte
        self.__fecha_generacion = datetime.now().isoformat()
        self.__generado_por = generado_por
        self._datos = []
    
    def get_titulo_reporte(self): return self.__titulo_reporte
    def set_titulo_reporte(self, valor):
        if not valor.strip(): raise ValueError("T√≠tulo vac√≠o")
        self.__titulo_reporte = valor
    
    def get_fecha_generacion(self): return self.__fecha_generacion
    def get_generado_por(self): return self.__generado_por
    def set_generado_por(self, valor):
        if not valor.strip(): raise ValueError("Generador vac√≠o")
        self.__generado_por = valor
    
    def generar_contenido(self): raise NotImplementedError("Abstracto")
    def exportar_formato(self, formato): raise NotImplementedError("Abstracto")
    
    def __procesar_datos(self, datos):
        if not datos: return []
        return [d for d in datos if d]
    
    def __calcular_estadisticas(self, datos):
        if not datos: return {"total": 0}
        try:
            nums = [float(d) for d in datos if isinstance(d, (int, float)) or (isinstance(d, str) and d.replace('.', '').isdigit())]
            if nums:
                return {
                    "total": len(datos),
                    "promedio": sum(nums) / len(nums),
                    "minimo": min(nums),
                    "maximo": max(nums)
                }
        except: pass
        return {"total": len(datos)}
    
    def obtener_fecha_formateada(self):
        return datetime.fromisoformat(self.__fecha_generacion).strftime("%d/%m/%Y %H:%M")
    
    def visualizar(self):
        contenido = self.generar_contenido()
        print(f"\n{'='*50}")
        print(f"üìä REPORTE: {self.__titulo_reporte}")
        print(f"{'='*50}")
        print(f"üë§ Generado por: {self.__generado_por}")
        print(f"üìÖ Fecha: {self.obtener_fecha_formateada()}")
        print(f"{'-'*50}")
        
        if isinstance(contenido, dict):
            for k, v in contenido.items():
                print(f"{k}: {v}")
        elif isinstance(contenido, list):
            for item in contenido:
                print(f"- {item}")
        else:
            print(contenido)
    
    def __str__(self): return f"Reporte: {self.__titulo_reporte}"

class ReportePrestamos(Reporte):
    def __init__(self, titulo, generador, fecha_inicio, fecha_fin):
        super().__init__(titulo, generador)
        self.__fecha_inicio = fecha_inicio
        self.__fecha_fin = fecha_fin
        self.__datos_prestamos = []
    
    def agregar_prestamo(self, usuario, material, fecha, estado):
        self.__datos_prestamos.append({
            'usuario': usuario,
            'material': material,
            'fecha': fecha,
            'estado': estado
        })
    
    def generar_contenido(self):
        filtrados = []
        for p in self.__datos_prestamos:
            if self.__fecha_inicio <= p['fecha'] <= self.__fecha_fin:
                filtrados.append(p)
        
        self._datos = self._Reporte__procesar_datos(filtrados)
        
        activos = len([p for p in self._datos if p['estado'] == 'activo'])
        devueltos = len([p for p in self._datos if p['estado'] == 'devuelto'])
        atrasados = len([p for p in self._datos if p['estado'] == 'atrasado'])
        
        return {
            'T√≠tulo': self.get_titulo_reporte(),
            'Per√≠odo': f"{self.__fecha_inicio} a {self.__fecha_fin}",
            'Total pr√©stamos': len(self._datos),
            'Activos': activos,
            'Devueltos': devueltos,
            'Atrasados': atrasados,
            'Tasa devoluci√≥n': f"{(devueltos/len(self._datos)*100):.1f}%" if self._datos else "0%"
        }
    
    def exportar_formato(self, formato="texto"):
        contenido = self.generar_contenido()
        
        if formato.lower() == "json":
            return json.dumps(contenido, indent=2, ensure_ascii=False)
        
        elif formato.lower() == "csv":
            output = StringIO()
            writer = csv.writer(output)
            writer.writerow(['Campo', 'Valor'])
            for k, v in contenido.items():
                writer.writerow([k, v])
            return output.getvalue()
        
        else:
            lines = []
            for k, v in contenido.items():
                lines.append(f"{k}: {v}")
            return "\n".join(lines)

class ReporteMateriales(Reporte):
    def __init__(self, titulo, generador, ordenar_por="mas_prestados"):
        super().__init__(titulo, generador)
        self.__ordenar_por = ordenar_por
        self.__datos_materiales = []
    
    def agregar_material(self, titulo, autor, prestamos):
        self.__datos_materiales.append({
            'titulo': titulo,
            'autor': autor,
            'prestamos': prestamos
        })
    
    def generar_contenido(self):
        if self.__ordenar_por == "mas_prestados":
            ordenados = sorted(self.__datos_materiales, key=lambda x: x['prestamos'], reverse=True)
        elif self.__ordenar_por == "menos_prestados":
            ordenados = sorted(self.__datos_materiales, key=lambda x: x['prestamos'])
        elif self.__ordenar_por == "titulo":
            ordenados = sorted(self.__datos_materiales, key=lambda x: x['titulo'])
        else:  # autor
            ordenados = sorted(self.__datos_materiales, key=lambda x: x['autor'])
        
        self._datos = self._Reporte__procesar_datos(ordenados)
        
        prestamos = [m['prestamos'] for m in self._datos]
        stats = self._Reporte__calcular_estadisticas(prestamos)
        
        contenido = {
            'T√≠tulo': self.get_titulo_reporte(),
            'Ordenado por': self.__ordenar_por,
            'Total materiales': len(self._datos),
            'Total pr√©stamos': stats['total'],
            'Promedio pr√©stamos': f"{stats.get('promedio', 0):.1f}",
            'M√°s prestado': max(self._datos, key=lambda x: x['prestamos'])['titulo'] if self._datos else "Ninguno"
        }
        
        # Top 3
        top3 = ordenados[:3]
        for i, m in enumerate(top3, 1):
            contenido[f'Top {i}'] = f"{m['titulo']} ({m['prestamos']})"
        
        return contenido
    
    def exportar_formato(self, formato="texto"):
        contenido = self.generar_contenido()
        
        if formato.lower() == "json":
            return json.dumps(contenido, indent=2, ensure_ascii=False)
        
        elif formato.lower() == "csv":
            output = StringIO()
            writer = csv.DictWriter(output, fieldnames=['Material', 'Autor', 'Pr√©stamos'])
            writer.writeheader()
            for m in self._datos:
                writer.writerow({
                    'Material': m['titulo'],
                    'Autor': m['autor'],
                    'Pr√©stamos': m['prestamos']
                })
            return output.getvalue()
        
        else:
            lines = [f"REPORTE: {self.get_titulo_reporte()}"]
            lines.append(f"Orden: {self.__ordenar_por}")
            for k, v in contenido.items():
                if k.startswith('Top'):
                    lines.append(f"{k}: {v}")
            return "\n".join(lines)

class ReporteUsuarios(Reporte):
    def __init__(self, titulo, generador, tipo_usuario=None, incluir_morosos=True):
        super().__init__(titulo, generador)
        self.__tipo_usuario = tipo_usuario
        self.__incluir_morosos = incluir_morosos
        self.__datos_usuarios = []
    
    def agregar_usuario(self, nombre, tipo, activos, atrasados, moroso):
        self.__datos_usuarios.append({
            'nombre': nombre,
            'tipo': tipo,
            'activos': activos,
            'atrasados': atrasados,
            'moroso': moroso
        })
    
    def generar_contenido(self):
        filtrados = self.__datos_usuarios
        
        if self.__tipo_usuario:
            filtrados = [u for u in filtrados if u['tipo'] == self.__tipo_usuario]
        
        if not self.__incluir_morosos:
            filtrados = [u for u in filtrados if not u['moroso']]
        
        self._datos = self._Reporte__procesar_datos(filtrados)
        
        tipos = {}
        morosos = []
        total_activos = 0
        
        for u in self._datos:
            tipo = u['tipo']
            tipos[tipo] = tipos.get(tipo, 0) + 1
            total_activos += u['activos']
            if u['moroso']:
                morosos.append(u['nombre'])
        
        contenido = {
            'T√≠tulo': self.get_titulo_reporte(),
            'Total usuarios': len(self._datos),
            'Pr√©stamos activos': total_activos,
            'Usuarios morosos': len(morosos)
        }
        
        for tipo, cantidad in tipos.items():
            contenido[f'{tipo.capitalize()}s'] = cantidad
        
        if morosos and self.__incluir_morosos:
            contenido['Lista morosos'] = ", ".join(morosos[:3])
        
        return contenido
    
    def exportar_formato(self, formato="texto"):
        contenido = self.generar_contenido()
        
        if formato.lower() == "json":
            return json.dumps(contenido, indent=2, ensure_ascii=False)
        
        elif formato.lower() == "csv":
            output = StringIO()
            writer = csv.DictWriter(output, fieldnames=['Usuario', 'Tipo', 'Activos', 'Moroso'])
            writer.writeheader()
            for u in self._datos:
                writer.writerow({
                    'Usuario': u['nombre'],
                    'Tipo': u['tipo'],
                    'Activos': u['activos'],
                    'Moroso': 'S√≠' if u['moroso'] else 'No'
                })
            return output.getvalue()
        
        else:
            lines = [f"REPORTE USUARIOS: {self.get_titulo_reporte()}"]
            for k, v in contenido.items():
                lines.append(f"{k}: {v}")
            return "\n".join(lines)

class ReporteFinanciero(Reporte):
    def __init__(self, titulo, generador, periodo):
        super().__init__(titulo, generador)
        self.__periodo = periodo
        self.__ingresos = []
        self.__multas = []
    
    def agregar_ingreso(self, concepto, monto, fecha):
        self.__ingresos.append({
            'concepto': concepto,
            'monto': float(monto),
            'fecha': fecha
        })
    
    def agregar_multa(self, usuario, monto, motivo, fecha):
        self.__multas.append({
            'usuario': usuario,
            'monto': float(monto),
            'motivo': motivo,
            'fecha': fecha
        })
    
    def generar_contenido(self):
        total_ingresos = sum(i['monto'] for i in self.__ingresos)
        total_multas = sum(m['monto'] for m in self.__multas)
        
        self._datos = self._Reporte__procesar_datos(self.__ingresos + self.__multas)
        
        montos_ingresos = [i['monto'] for i in self.__ingresos]
        stats_ingresos = self._Reporte__calcular_estadisticas(montos_ingresos)
        
        montos_multas = [m['monto'] for m in self.__multas]
        stats_multas = self._Reporte__calcular_estadisticas(montos_multas)
        
        return {
            'T√≠tulo': self.get_titulo_reporte(),
            'Per√≠odo': self.__periodo,
            'Total ingresos': f"${total_ingresos:.2f}",
            'Total multas': f"${total_multas:.2f}",
            'Balance': f"${total_ingresos + total_multas:.2f}",
            'Transacciones': len(self._datos),
            'Ingreso promedio': f"${stats_ingresos.get('promedio', 0):.2f}",
            'Multa promedio': f"${stats_multas.get('promedio', 0):.2f}"
        }
    
    def exportar_formato(self, formato="texto"):
        contenido = self.generar_contenido()
        
        if formato.lower() == "json":
            return json.dumps(contenido, indent=2, ensure_ascii=False)
        
        elif formato.lower() == "csv":
            output = StringIO()
            writer = csv.writer(output)
            writer.writerow(['Concepto', 'Valor'])
            for k, v in contenido.items():
                writer.writerow([k, v])
            return output.getvalue()
        
        else:
            lines = [f"REPORTE FINANCIERO: {self.get_titulo_reporte()}"]
            lines.append(f"Per√≠odo: {self.__periodo}")
            for k in ['Total ingresos', 'Total multas', 'Balance', 'Transacciones']:
                if k in contenido:
                    lines.append(f"{k}: {contenido[k]}")
            return "\n".join(lines)

class ReporteService:
    def __init__(self):
        self.reportes = []
    
    def crear_reporte_prestamos(self):
        reporte = ReportePrestamos(
            "Pr√©stamos Enero 2024",
            "Administrador",
            "2024-01-01",
            "2024-01-31"
        )
        
        # Datos de ejemplo
        datos = [
            ("Ana L√≥pez", "Cien A√±os de Soledad", "2024-01-10", "devuelto"),
            ("Carlos Ruiz", "Python Crash Course", "2024-01-15", "activo"),
            ("Dr. Mart√≠nez", "F√≠sica Universitaria", "2024-01-20", "devuelto"),
            ("Dra. Gonz√°lez", "Clean Code", "2024-01-25", "atrasado"),
            ("Juan Garc√≠a", "El Quijote", "2024-01-05", "devuelto")
        ]
        
        for usuario, material, fecha, estado in datos:
            reporte.agregar_prestamo(usuario, material, fecha, estado)
        
        self.reportes.append(reporte)
        return reporte
    
    def crear_reporte_materiales(self):
        reporte = ReporteMateriales(
            "Materiales M√°s Solicitados 2024",
            "Bibliotecario",
            "mas_prestados"
        )
        
        # Datos de ejemplo
        materiales = [
            ("Cien A√±os de Soledad", "Gabriel Garc√≠a M√°rquez", 45),
            ("Python Crash Course", "Eric Matthes", 38),
            ("Clean Code", "Robert C. Martin", 32),
            ("1984", "George Orwell", 28),
            ("El Quijote", "Miguel de Cervantes", 25)
        ]
        
        for titulo, autor, prestamos in materiales:
            reporte.agregar_material(titulo, autor, prestamos)
        
        self.reportes.append(reporte)
        return reporte
    
    def crear_reporte_usuarios(self):
        reporte = ReporteUsuarios(
            "Usuarios Activos con Morosos",
            "Administraci√≥n",
            None,  # Todos los tipos
            True   # Incluir morosos
        )
        
        # Datos de ejemplo
        usuarios = [
            ("Ana L√≥pez", "estudiante", 2, 1, True),
            ("Carlos Ruiz", "estudiante", 1, 0, False),
            ("Dr. Mart√≠nez", "profesor", 3, 0, False),
            ("Dra. Gonz√°lez", "profesor", 4, 2, True),
            ("Juan Garc√≠a", "publico", 1, 1, True)
        ]
        
        for nombre, tipo, activos, atrasados, moroso in usuarios:
            reporte.agregar_usuario(nombre, tipo, activos, atrasados, moroso)
        
        self.reportes.append(reporte)
        return reporte
    
    def crear_reporte_financiero(self):
        reporte = ReporteFinanciero(
            "Balance Financiero Q1 2024",
            "Contabilidad",
            "Enero - Marzo 2024"
        )
        
        # Datos de ejemplo
        reporte.agregar_ingreso("Pr√©stamos estudiantes", 150.00, "2024-01-15")
        reporte.agregar_ingreso("Pr√©stamos profesores", 250.00, "2024-02-10")
        reporte.agregar_ingreso("Renovaciones", 75.50, "2024-03-05")
        
        reporte.agregar_multa("Ana L√≥pez", 7.50, "Retraso 15 d√≠as", "2024-01-30")
        reporte.agregar_multa("Dra. Gonz√°lez", 10.00, "Retraso 20 d√≠as", "2024-02-25")
        reporte.agregar_multa("Juan Garc√≠a", 3.00, "Retraso 6 d√≠as", "2024-03-20")
        
        self.reportes.append(reporte)
        return reporte

class ReporteMenu:
    def __init__(self):
        self.service = ReporteService()
    
    def mostrar_menu(self):
        print("\n" + "="*50)
        print("üìä SISTEMA DE REPORTES Y ESTAD√çSTICAS")
        print("="*50)
        print("1. Generar reporte de pr√©stamos")
        print("2. Generar reporte de materiales")
        print("3. Generar reporte de usuarios")
        print("4. Generar reporte financiero")
        print("5. Ver todos los reportes")
        print("6. Exportar reportes a diferentes formatos")
        print("7. Demostrar polimorfismo")
        print("8. Demostrar encapsulamiento")
        print("9. Verificar clase abstracta")
        print("0. Salir")
        print("-"*50)
    
    def get_input(self, prompt, tipo=str):
        while True:
            try:
                valor = input(prompt).strip()
                if tipo == int: return int(valor)
                return valor
            except: print("‚ùå Valor inv√°lido")
    
    def generar_reporte_prestamos(self):
        print("\nüìã GENERANDO REPORTE DE PR√âSTAMOS...")
        reporte = self.service.crear_reporte_prestamos()
        reporte.visualizar()
    
    def generar_reporte_materiales(self):
        print("\nüìö GENERANDO REPORTE DE MATERIALES...")
        reporte = self.service.crear_reporte_materiales()
        reporte.visualizar()
    
    def generar_reporte_usuarios(self):
        print("\nüë• GENERANDO REPORTE DE USUARIOS...")
        reporte = self.service.crear_reporte_usuarios()
        reporte.visualizar()
    
    def generar_reporte_financiero(self):
        print("\nüí∞ GENERANDO REPORTE FINANCIERO...")
        reporte = self.service.crear_reporte_financiero()
        reporte.visualizar()
    
    def ver_todos_reportes(self):
        if not self.service.reportes:
            print("‚ùå No hay reportes generados")
            return
        
        print("\nüìä TODOS LOS REPORTES:")
        for i, reporte in enumerate(self.service.reportes, 1):
            print(f"{i}. {reporte}")
            contenido = reporte.generar_contenido()
            if isinstance(contenido, dict):
                items = list(contenido.items())[:2]
                for k, v in items:
                    print(f"   {k}: {v}")
            print()
    
    def exportar_reportes(self):
        if not self.service.reportes:
            print("‚ùå No hay reportes para exportar")
            return
        
        print("\nüì§ FORMATOS DE EXPORTACI√ìN:")
        print("1. Texto")
        print("2. JSON")
        print("3. CSV")
        
        formato_opcion = self.get_input("Seleccione formato: ", int)
        formatos = {1: "texto", 2: "json", 3: "csv"}
        
        if formato_opcion not in formatos:
            print("‚ùå Opci√≥n inv√°lida")
            return
        
        formato = formatos[formato_opcion]
        
        print(f"\nüìÑ EXPORTANDO A {formato.upper()}:")
        for i, reporte in enumerate(self.service.reportes, 1):
            try:
                exportado = reporte.exportar_formato(formato)
                print(f"{i}. {reporte.get_titulo_reporte()}:")
                print(f"   Longitud: {len(exportado)} caracteres")
                if formato == "texto":
                    lineas = exportado.split('\n')
                    for linea in lineas[:3]:
                        print(f"   {linea}")
                    if len(lineas) > 3:
                        print(f"   ... ({len(lineas)-3} l√≠neas m√°s)")
                print()
            except Exception as e:
                print(f"{i}. Error: {e}")
    
    def demostrar_polimorfismo(self):
        print("\nüéØ DEMOSTRACI√ìN DE POLIMORFISMO")
        print("-"*40)
        
        # Crear reportes de ejemplo
        reportes = [
            ReportePrestamos("Pr√©stamos Test", "Admin", "2024-01-01", "2024-01-31"),
            ReporteMateriales("Materiales Test", "Admin", "mas_prestados"),
            ReporteUsuarios("Usuarios Test", "Admin", None, True),
            ReporteFinanciero("Financiero Test", "Admin", "Test")
        ]
        
        # Agregar datos m√≠nimos
        reportes[0].agregar_prestamo("Test", "Test", "2024-01-15", "activo")
        reportes[1].agregar_material("Test", "Autor", 10)
        reportes[2].agregar_usuario("Test", "estudiante", 1, 0, False)
        reportes[3].agregar_ingreso("Test", 100.00, "2024-01-01")
        
        print("üìã Reportes creados:")
        for r in reportes:
            print(f"  {r.__class__.__name__}: {r.get_titulo_reporte()}")
        
        print("\nüîÑ Generando contenido (polimorfismo):")
        for r in reportes:
            contenido = r.generar_contenido()
            print(f"  {r.__class__.__name__:<20} ‚Üí {type(contenido).__name__}")
        
        print("\nüì§ Exportando a diferentes formatos:")
        for r in reportes:
            for formato in ["texto", "json", "csv"]:
                try:
                    exportado = r.exportar_formato(formato)
                    print(f"  {r.__class__.__name__:<20} {formato:<6} ‚Üí {len(exportado)} chars")
                except:
                    print(f"  {r.__class__.__name__:<20} {formato:<6} ‚Üí Error")
        
        print("\n‚úÖ Polimorfismo demostrado")
    
    def demostrar_encapsulamiento(self):
        print("\nüîí DEMOSTRACI√ìN DE ENCAPSULAMIENTO")
        print("-"*40)
        
        reporte = ReportePrestamos("Test", "Admin", "2024-01-01", "2024-01-31")
        
        print("‚úÖ Acceso mediante m√©todos p√∫blicos:")
        print(f"  T√≠tulo: {reporte.get_titulo_reporte()}")
        print(f"  Generado por: {reporte.get_generado_por()}")
        
        print("\n‚úÖ Validaci√≥n en setters:")
        try: reporte.set_titulo_reporte("")
        except ValueError as e: print(f"  ‚úÖ Correcto: {e}")
        
        print("\n‚ùå Intentando acceso a m√©todos privados:")
        try: procesado = reporte.__procesar_datos([])
        except AttributeError: print("  ‚úÖ Correcto: M√©todo privado no accesible")
        
        try: stats = reporte.__calcular_estadisticas([])
        except AttributeError: print("  ‚úÖ Correcto: M√©todo privado no accesible")
    
    def verificar_clase_abstracta(self):
        print("\n‚ö†Ô∏è VERIFICANDO CLASE ABSTRACTA")
        print("-"*40)
        try: reporte = Reporte("Test", "Admin")
        except (TypeError, NotImplementedError) as e: print(f"‚úÖ Correcto: {e}")
    
    def run(self):
        print("üöÄ INICIANDO SISTEMA DE REPORTES...")
        while True:
            self.mostrar_menu()
            opcion = self.get_input("Opci√≥n: ", str)
            if opcion == "0": print("üëã ¬°Adi√≥s!"); break
            elif opcion == "1": self.generar_reporte_prestamos()
            elif opcion == "2": self.generar_reporte_materiales()
            elif opcion == "3": self.generar_reporte_usuarios()
            elif opcion == "4": self.generar_reporte_financiero()
            elif opcion == "5": self.ver_todos_reportes()
            elif opcion == "6": self.exportar_reportes()
            elif opcion == "7": self.demostrar_polimorfismo()
            elif opcion == "8": self.demostrar_encapsulamiento()
            elif opcion == "9": self.verificar_clase_abstracta()
            else: print("‚ùå Opci√≥n inv√°lida")
            if opcion != "0": input("\n‚èé Presiona Enter...")

menu = ReporteMenu()
menu.run()
