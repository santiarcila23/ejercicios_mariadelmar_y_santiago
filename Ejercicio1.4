"""
EJERCICIO 1.4: SISTEMA DE REPORTES Y ESTAD√çSTICAS
"""

from datetime import datetime, timedelta
import json
import csv
from io import StringIO

class Reporte:
    def __init__(self, titulo_reporte, generado_por):
        self.__titulo_reporte = titulo_reporte
        self.__fecha_generacion = datetime.now()
        self.__generado_por = generado_por
        self._datos = []
    
    def get_titulo_reporte(self):
        return self.__titulo_reporte
    
    def get_fecha_generacion(self):
        return self.__fecha_generacion
    
    def get_generado_por(self):
        return self.__generado_por
    
    def obtener_fecha_generacion(self):
        return self.__fecha_generacion.strftime("%d/%m/%Y %H:%M:%S")
    
    def generar_contenido(self):
        raise NotImplementedError("M√©todo debe implementarse")
    
    def exportar_formato(self, formato="texto"):
        raise NotImplementedError("M√©todo debe implementarse")
    
    def visualizar(self):
        contenido = self.generar_contenido()
        print(f"\n{'='*60}")
        print(f"üìä {self.__titulo_reporte}")
        print(f"{'='*60}")
        print(f"üìÖ Generado: {self.obtener_fecha_generacion()}")
        print(f"üë§ Por: {self.__generado_por}")
        print(f"{'-'*60}")
        
        if isinstance(contenido, dict):
            for clave, valor in contenido.items():
                if clave != 'Detalles':
                    print(f"{clave}: {valor}")
            
            if 'Detalles' in contenido and contenido['Detalles']:
                print(f"\nüìã Detalles:")
                for detalle in contenido['Detalles'][:5]:  # Mostrar solo 5
                    if isinstance(detalle, dict):
                        print(f"  - {list(detalle.values())[0]}")
                    else:
                        print(f"  - {detalle}")
                if len(contenido['Detalles']) > 5:
                    print(f"  ... y {len(contenido['Detalles']) - 5} m√°s")
        else:
            print(contenido)
        
        print(f"{'='*60}")
    
    def __str__(self):
        return f"Reporte: {self.__titulo_reporte}"

class ReportePrestamos(Reporte):
    def __init__(self, generado_por, filtro_fecha_inicio=None, filtro_fecha_fin=None):
        super().__init__("REPORTE DE PR√âSTAMOS", generado_por)
        self.__filtro_fecha_inicio = filtro_fecha_inicio or (datetime.now() - timedelta(days=30))
        self.__filtro_fecha_fin = filtro_fecha_fin or datetime.now()
    
    def _procesar_datos(self, transacciones):
        datos_procesados = []
        for trans in transacciones:
            if hasattr(trans, 'get_fecha') and self.__filtro_fecha_inicio <= trans.get_fecha() <= self.__filtro_fecha_fin:
                datos_procesados.append({
                    'id': trans.get_id_transaccion(),
                    'usuario': trans.get_usuario().get_nombre() if hasattr(trans.get_usuario(), 'get_nombre') else "N/A",
                    'material': trans.get_material().get_titulo() if hasattr(trans.get_material(), 'get_titulo') else "N/A",
                    'fecha': trans.get_fecha().strftime("%d/%m/%Y"),
                    'estado': trans.get_estado(),
                    'costo': f"${trans.calcular_costo():.2f}" if hasattr(trans, 'calcular_costo') else "$0.00"
                })
        return datos_procesados
    
    def _calcular_estadisticas(self, datos):
        if not datos:
            return {'aprobados': 0, 'pendientes': 0, 'ingresos': 0, 'total': 0}
        
        aprobados = sum(1 for d in datos if d['estado'] == 'aprobada')
        pendientes = sum(1 for d in datos if d['estado'] == 'pendiente')
        
        # Extraer valores num√©ricos de costo
        ingresos = 0
        for d in datos:
            try:
                costo_str = d['costo'].replace('$', '').replace(',', '')
                ingresos += float(costo_str)
            except:
                pass
        
        return {
            'aprobados': aprobados,
            'pendientes': pendientes,
            'ingresos': ingresos,
            'total': len(datos)
        }
    
    def generar_contenido(self):
        # Intentar obtener datos de ejercicios anteriores
        transacciones = []
        try:
            from ejercicio_1_3_menu import Prestamo, Renovacion, Reserva, Devolucion
            from ejercicio_1_1_menu import LibroFisico
            from ejercicio_1_2_menu import Estudiante
            
            # Crear datos de ejemplo si no hay
            usuario_ej = Estudiante("Ejemplo", "123", "ej@email.com", "Carrera", 3)
            material_ej = LibroFisico("Libro Ej", "Autor", 2023, "EJ", 200, "Ed", "bueno")
            
            # Crear transacciones de ejemplo
            transacciones = [
                Prestamo("P-001", usuario_ej, material_ej),
                Renovacion("R-001", usuario_ej, material_ej, None),
                Reserva("RS-001", usuario_ej, material_ej),
                Devolucion("D-001", usuario_ej, material_ej, None)
            ]
            
            for t in transacciones:
                t.procesar_transaccion()
                
        except ImportError:
            # Si no se pueden importar, usar datos simulados
            print("‚ö†Ô∏è  Usando datos simulados para el reporte")
            transacciones = []  # Lista vac√≠a para datos simulados
        
        self._datos = self._procesar_datos(transacciones)
        estadisticas = self._calcular_estadisticas(self._datos)
        
        return {
            'Total pr√©stamos': estadisticas['total'],
            'Per√≠odo': f"{self.__filtro_fecha_inicio.strftime('%d/%m/%Y')} - {self.__filtro_fecha_fin.strftime('%d/%m/%Y')}",
            'Pr√©stamos aprobados': estadisticas['aprobados'],
            'Pr√©stamos pendientes': estadisticas['pendientes'],
            'Ingresos totales': f"${estadisticas['ingresos']:.2f}",
            'Detalles': self._datos
        }
    
    def exportar_formato(self, formato="texto"):
        contenido = self.generar_contenido()
        
        if formato == "texto":
            resultado = f"Reporte: {self.get_titulo_reporte()}\n"
            resultado += f"Generado: {self.obtener_fecha_generacion()}\n"
            resultado += f"Por: {self.get_generado_por()}\n"
            resultado += f"Per√≠odo: {contenido['Per√≠odo']}\n\n"
            
            for clave, valor in contenido.items():
                if clave not in ['Per√≠odo', 'Detalles']:
                    resultado += f"{clave}: {valor}\n"
            
            resultado += "\nüìã Detalles:\n"
            for detalle in contenido['Detalles']:
                resultado += f"- {detalle}\n"
            
            return resultado
        
        elif formato == "json":
            return json.dumps(contenido, indent=2, ensure_ascii=False)
        
        elif formato == "csv":
            output = StringIO()
            writer = csv.writer(output)
            
            # Encabezado
            writer.writerow(['REPORTE DE PR√âSTAMOS'])
            writer.writerow(['Generado:', self.obtener_fecha_generacion()])
            writer.writerow(['Por:', self.get_generado_por()])
            writer.writerow([])
            
            # Estad√≠sticas
            writer.writerow(['ESTAD√çSTICAS'])
            writer.writerow(['Campo', 'Valor'])
            for clave, valor in contenido.items():
                if clave != 'Detalles':
                    writer.writerow([clave, valor])
            
            # Detalles
            if contenido['Detalles']:
                writer.writerow([])
                writer.writerow(['DETALLES DE PR√âSTAMOS'])
                headers = contenido['Detalles'][0].keys()
                writer.writerow(headers)
                for fila in contenido['Detalles']:
                    writer.writerow(fila.values())
            
            return output.getvalue()
        
        return "Formato no soportado"

class ReporteMateriales(Reporte):
    def __init__(self, generado_por, ordenar_por="mas_prestados"):
        super().__init__("REPORTE DE MATERIALES", generado_por)
        self.__ordenar_por = ordenar_por
    
    def _procesar_datos(self, materiales):
        # Datos simulados de pr√©stamos por material
        prestamos_simulados = {
            "LIB001": 15, "LIB002": 8, "ELE001": 25, "ELE002": 12,
            "REV001": 5, "REV002": 3, "AUD001": 18, "AUD002": 10
        }
        
        datos_procesados = []
        for material in materiales:
            veces_prestado = prestamos_simulados.get(material.get_codigo_unico(), 0)
            
            datos_procesados.append({
                'c√≥digo': material.get_codigo_unico(),
                't√≠tulo': material.get_titulo(),
                'tipo': material.obtener_tipo_material(),
                'autor': material.get_autor(),
                'a√±o': material.get_a√±o_publicacion(),
                'pr√©stamos': veces_prestado
            })
        
        # Ordenar seg√∫n criterio
        if self.__ordenar_por == "mas_prestados":
            datos_procesados.sort(key=lambda x: x['pr√©stamos'], reverse=True)
        elif self.__ordenar_por == "menos_prestados":
            datos_procesados.sort(key=lambda x: x['pr√©stamos'])
        elif self.__ordenar_por == "titulo":
            datos_procesados.sort(key=lambda x: x['t√≠tulo'])
        
        return datos_procesados
    
    def _calcular_estadisticas(self, datos):
        if not datos:
            return {'mas_solicitado': 'N/A', 'menos_solicitado': 'N/A', 
                    'promedio': 0, 'total': 0, 'tipos': {}}
        
        prestamos = [d['pr√©stamos'] for d in datos]
        tipos = {}
        for d in datos:
            tipo = d['tipo']
            tipos[tipo] = tipos.get(tipo, 0) + 1
        
        return {
            'mas_solicitado': datos[0]['t√≠tulo'] if datos[0]['pr√©stamos'] > 0 else 'N/A',
            'menos_solicitado': datos[-1]['t√≠tulo'] if datos[-1]['pr√©stamos'] > 0 else 'N/A',
            'promedio': sum(prestamos) / len(prestamos) if prestamos else 0,
            'total': len(datos),
            'tipos': tipos
        }
    
    def generar_contenido(self):
        # Intentar obtener materiales de ejercicios anteriores
        materiales = []
        try:
            from ejercicio_1_1_menu import LibroFisico, LibroElectronico, Revista, Audiolibro
            
            # Crear materiales de ejemplo
            materiales = [
                LibroFisico("Cien A√±os de Soledad", "Gabriel Garc√≠a M√°rquez", 
                           1967, "LIB001", 471, "Sudamericana", "bueno"),
                LibroFisico("Don Quijote", "Miguel de Cervantes", 
                           1605, "LIB002", 863, "Robles", "regular"),
                LibroElectronico("Python Crash Course", "Eric Matthes", 
                                2015, "ELE001", 5.2, "PDF", "http://ejemplo.com"),
                LibroElectronico("Clean Code", "Robert Martin", 
                                2008, "ELE002", 3.8, "EPUB", "http://ejemplo.com"),
                Revista("National Geographic", "Varios Autores", 
                       2023, "REV001", 245, "Octubre"),
                Revista("Scientific American", "Varios Autores", 
                       2023, "REV002", 321, "Noviembre"),
                Audiolibro("El Principito", "Antoine de Saint-Exup√©ry", 
                          1943, "AUD001", 120, "Narrador", "MP3"),
                Audiolibro("1984", "George Orwell", 
                          1949, "AUD002", 300, "Narrador", "MP3")
            ]
        except ImportError:
            # Si no se pueden importar, usar datos simulados
            print("‚ö†Ô∏è  Usando datos simulados para el reporte")
            materiales = []  # Lista vac√≠a para datos simulados
        
        self._datos = self._procesar_datos(materiales)
        estadisticas = self._calcular_estadisticas(self._datos)
        
        return {
            'Total materiales': estadisticas['total'],
            'Ordenado por': self.__ordenar_por.replace('_', ' ').title(),
            'Material m√°s solicitado': estadisticas['mas_solicitado'],
            'Material menos solicitado': estadisticas['menos_solicitado'],
            'Promedio pr√©stamos': f"{estadisticas['promedio']:.1f}",
            'Distribuci√≥n por tipo': estadisticas['tipos'],
            'Detalles': self._datos
        }
    
    def exportar_formato(self, formato="texto"):
        contenido = self.generar_contenido()
        
        if formato == "texto":
            resultado = f"REPORTE DE MATERIALES\n"
            resultado += f"{'='*40}\n"
            resultado += f"Ordenado por: {contenido['Ordenado por']}\n\n"
            
            resultado += f"{'C√ìDIGO':<10} {'T√çTULO':<25} {'TIPO':<15} {'PR√âSTAMOS':>10}\n"
            resultado += f"{'-'*60}\n"
            
            for detalle in contenido['Detalles']:
                titulo_corto = detalle['t√≠tulo'][:22] + '...' if len(detalle['t√≠tulo']) > 25 else detalle['t√≠tulo']
                resultado += f"{detalle['c√≥digo']:<10} {titulo_corto:<25} {detalle['tipo'][:13]:<15} {detalle['pr√©stamos']:>10}\n"
            
            return resultado
        
        elif formato == "json":
            return json.dumps(contenido, indent=2, ensure_ascii=False)
        
        return "Formato no soportado"

class ReporteUsuarios(Reporte):
    def __init__(self, generado_por, tipo_usuario=None, incluir_morosos=True):
        super().__init__("REPORTE DE USUARIOS", generado_por)
        self.__tipo_usuario = tipo_usuario
        self.__incluir_morosos = incluir_morosos
    
    def _procesar_datos(self, usuarios):
        datos_procesados = []
        for usuario in usuarios:
            if self.__tipo_usuario and usuario.__class__.__name__ != self.__tipo_usuario:
                continue
            
            # Simular datos de morosidad
            moroso_simulado = "Moroso" in usuario.get_nombre()
            
            if self.__incluir_morosos or not moroso_simulado:
                prestamos_activos = len([p for p in usuario.get_historial_prestamos() 
                                        if not p.get('devuelto', False)])
                
                datos_procesados.append({
                    'nombre': usuario.get_nombre(),
                    'tipo': usuario.__class__.__name__,
                    'email': usuario.get_email(),
                    'registro': usuario.get_fecha_registro().strftime("%d/%m/%Y"),
                    'l√≠mite': usuario.obtener_limite_prestamos(),
                    'd√≠as pr√©stamo': usuario.calcular_dias_prestamo(),
                    'pr√©stamos activos': prestamos_activos,
                    'moroso': "S√≠" if moroso_simulado else "No"
                })
        
        return datos_procesados
    
    def _calcular_estadisticas(self, datos):
        if not datos:
            return {'morosos': 0, 'promedio_prestamos': 0, 'total': 0, 'tipos': {}}
        
        morosos = sum(1 for d in datos if d['moroso'] == "S√≠")
        total_prestamos = sum(d['pr√©stamos activos'] for d in datos)
        tipos = {}
        
        for d in datos:
            tipo = d['tipo']
            tipos[tipo] = tipos.get(tipo, 0) + 1
        
        return {
            'morosos': morosos,
            'promedio_prestamos': total_prestamos / len(datos) if datos else 0,
            'total': len(datos),
            'tipos': tipos
        }
    
    def generar_contenido(self):
        # Intentar obtener usuarios de ejercicios anteriores
        usuarios = []
        try:
            from ejercicio_1_2_menu import Estudiante, Profesor, Investigador, UsuarioPublico
            
            # Crear usuarios de ejemplo
            usuarios = [
                Estudiante("Ana L√≥pez", "EST001", "ana@edu.com", "Sistemas", 5),
                Estudiante("Carlos Ruiz", "EST002", "carlos@edu.com", "Medicina", 8),
                Estudiante("Estudiante Moroso", "EST003", "moroso@edu.com", "Derecho", 3),
                Profesor("Dr. Mart√≠nez", "PROF001", "martinez@edu.com", "Matem√°ticas"),
                Profesor("Dra. G√≥mez", "PROF002", "gomez@edu.com", "Literatura"),
                Investigador("Dr. Rodr√≠guez", "INV001", "rodriguez@edu.com", "IA"),
                UsuarioPublico("Juan Torres", "PUB001", "juan@email.com")
            ]
        except ImportError:
            # Si no se pueden importar, usar datos simulados
            print("‚ö†Ô∏è  Usando datos simulados para el reporte")
            usuarios = []  # Lista vac√≠a para datos simulados
        
        self._datos = self._procesar_datos(usuarios)
        estadisticas = self._calcular_estadisticas(self._datos)
        
        return {
            'Total usuarios': estadisticas['total'],
            'Filtro tipo': self.__tipo_usuario or "Todos",
            'Incluye morosos': "S√≠" if self.__incluir_morosos else "No",
            'Usuarios morosos': estadisticas['morosos'],
            'Promedio pr√©stamos activos': f"{estadisticas['promedio_prestamos']:.1f}",
            'Distribuci√≥n por tipo': estadisticas['tipos'],
            'Detalles': self._datos
        }
    
    def exportar_formato(self, formato="texto"):
        contenido = self.generar_contenido()
        
        if formato == "texto":
            resultado = f"REPORTE DE USUARIOS\n"
            resultado += f"{'='*40}\n"
            resultado += f"Tipo: {contenido['Filtro tipo']} | Morosos: {contenido['Incluye morosos']}\n\n"
            
            resultado += f"{'NOMBRE':<20} {'TIPO':<12} {'EMAIL':<20} {'MOROSO':<6} {'ACTIVOS':>8}\n"
            resultado += f"{'-'*66}\n"
            
            for detalle in contenido['Detalles']:
                nombre_corto = detalle['nombre'][:18] + '..' if len(detalle['nombre']) > 20 else detalle['nombre']
                email_corto = detalle['email'][:18] + '..' if len(detalle['email']) > 20 else detalle['email']
                resultado += f"{nombre_corto:<20} {detalle['tipo'][:10]:<12} {email_corto:<20} {detalle['moroso']:<6} {detalle['pr√©stamos activos']:>8}\n"
            
            return resultado
        
        elif formato == "json":
            return json.dumps(contenido, indent=2, ensure_ascii=False)
        
        return "Formato no soportado"

class ReporteFinanciero(Reporte):
    def __init__(self, generado_por, periodo="mensual"):
        super().__init__("REPORTE FINANCIERO", generado_por)
        self.__periodo = periodo
    
    def generar_contenido(self):
        # Datos simulados seg√∫n per√≠odo
        ingresos_simulados = {
            "diario": 150.75,
            "semanal": 1055.25,
            "mensual": 4522.50,
            "anual": 54270.00
        }
        
        multas_simuladas = {
            "diario": 25.50,
            "semanal": 178.50,
            "mensual": 765.00,
            "anual": 9180.00
        }
        
        ingresos = ingresos_simulados.get(self.__periodo, 0)
        multas = multas_simuladas.get(self.__periodo, 0)
        total = ingresos + multas
        
        porcentaje_multas = (multas / total * 100) if total > 0 else 0
        
        tendencia = "üìà Creciente" if multas < ingresos * 0.1 else "üìâ Decreciente"
        
        return {
            'Per√≠odo': self.__periodo.title(),
            'Total ingresos pr√©stamos': f"${ingresos:,.2f}",
            'Total multas por retraso': f"${multas:,.2f}",
            'Ingresos totales': f"${total:,.2f}",
            'Porcentaje multas': f"{porcentaje_multas:.1f}%",
            'Promedio diario': f"${(total / 30):,.2f}" if self.__periodo == 'mensual' else "N/A",
            'Tendencia': tendencia,
            'Detalles': [f"Ingresos por {self.__periodo}", f"Multas por {self.__periodo}"]
        }
    
    def exportar_formato(self, formato="texto"):
        contenido = self.generar_contenido()
        
        if formato == "texto":
            resultado = f"REPORTE FINANCIERO - {self.__periodo.upper()}\n"
            resultado += f"{'='*40}\n\n"
            
            for clave, valor in contenido.items():
                if clave != 'Detalles':
                    resultado += f"{clave}: {valor}\n"
            
            return resultado
        
        elif formato == "json":
            return json.dumps(contenido, indent=2, ensure_ascii=False)
        
        elif formato == "csv":
            output = StringIO()
            writer = csv.writer(output)
            
            writer.writerow(['REPORTE FINANCIERO', self.__periodo.title()])
            writer.writerow(['Generado:', self.obtener_fecha_generacion()])
            writer.writerow(['Por:', self.get_generado_por()])
            writer.writerow([])
            writer.writerow(['CONCEPTO', 'VALOR'])
            
            for clave, valor in contenido.items():
                if clave != 'Detalles':
                    writer.writerow([clave, valor])
            
            return output.getvalue()
        
        return "Formato no soportado"

# ========== MEN√ö INTERACTIVO ==========
class MenuReportes:
    def __init__(self):
        self.reportes_generados = []
    
    def mostrar_menu_principal(self):
        print("\n" + "="*60)
        print("üìä SISTEMA DE REPORTES Y ESTAD√çSTICAS")
        print("="*60)
        print("1. üìñ Generar reporte de pr√©stamos")
        print("2. üìö Generar reporte de materiales")
        print("3. üë• Generar reporte de usuarios")
        print("4. üí∞ Generar reporte financiero")
        print("5. üëÄ Ver todos los reportes generados")
        print("6. üíæ Exportar reporte a formato")
        print("7. üéØ Demostrar polimorfismo")
        print("8. üîí Demostrar encapsulamiento")
        print("9. üìà Comparar reportes")
        print("0. üö™ Salir")
        print("-"*60)
    
    def obtener_entrada(self, mensaje, tipo=str):
        while True:
            try:
                entrada = input(f"{mensaje}: ").strip()
                if tipo == int:
                    return int(entrada)
                elif tipo == float:
                    return float(entrada)
                return entrada
            except ValueError:
                print("‚ùå Entrada inv√°lida. Intente nuevamente.")
    
    def generar_reporte_prestamos(self):
        print("\n" + "="*40)
        print("üìñ GENERAR REPORTE DE PR√âSTAMOS")
        print("="*40)
        
        generado_por = self.obtener_entrada("Generado por")
        
        print("\nüîç Configurar filtro de fechas:")
        print("1. √öltimos 30 d√≠as (predeterminado)")
        print("2. √öltima semana")
        print("3. √öltimo a√±o")
        print("4. Personalizado")
        
        opcion = self.obtener_entrada("Seleccione per√≠odo", int)
        
        fecha_inicio = None
        fecha_fin = None
        
        if opcion == 1:
            fecha_inicio = datetime.now() - timedelta(days=30)
            fecha_fin = datetime.now()
        elif opcion == 2:
            fecha_inicio = datetime.now() - timedelta(days=7)
            fecha_fin = datetime.now()
        elif opcion == 3:
            fecha_inicio = datetime.now() - timedelta(days=365)
            fecha_fin = datetime.now()
        elif opcion == 4:
            print("‚ö†Ô∏è  Fecha personalizada no implementada, usando predeterminado")
            fecha_inicio = datetime.now() - timedelta(days=30)
            fecha_fin = datetime.now()
        else:
            fecha_inicio = datetime.now() - timedelta(days=30)
            fecha_fin = datetime.now()
        
        try:
            reporte = ReportePrestamos(generado_por, fecha_inicio, fecha_fin)
            self.reportes_generados.append(reporte)
            print(f"\n‚úÖ Reporte generado exitosamente!")
            reporte.visualizar()
        except Exception as e:
            print(f"‚ùå Error al generar reporte: {e}")
    
    def generar_reporte_materiales(self):
        print("\n" + "="*40)
        print("üìö GENERAR REPORTE DE MATERIALES")
        print("="*40)
        
        generado_por = self.obtener_entrada("Generado por")
        
        print("\nüîç Ordenar por:")
        print("1. M√°s prestados")
        print("2. Menos prestados")
        print("3. T√≠tulo (A-Z)")
        
        opcion = self.obtener_entrada("Seleccione orden", int)
        
        orden = "mas_prestados"
        if opcion == 1:
            orden = "mas_prestados"
        elif opcion == 2:
            orden = "menos_prestados"
        elif opcion == 3:
            orden = "titulo"
        
        try:
            reporte = ReporteMateriales(generado_por, orden)
            self.reportes_generados.append(reporte)
            print(f"\n‚úÖ Reporte generado exitosamente!")
            reporte.visualizar()
        except Exception as e:
            print(f"‚ùå Error al generar reporte: {e}")
    
    def generar_reporte_usuarios(self):
        print("\n" + "="*40)
        print("üë• GENERAR REPORTE DE USUARIOS")
        print("="*40)
        
        generado_por = self.obtener_entrada("Generado por")
        
        print("\nüîç Filtrar por tipo de usuario:")
        print("1. Todos los usuarios")
        print("2. Solo estudiantes")
        print("3. Solo profesores")
        print("4. Solo investigadores")
        print("5. Solo usuarios p√∫blicos")
        
        opcion_tipo = self.obtener_entrada("Seleccione tipo", int)
        
        tipo_usuario = None
        if opcion_tipo == 1:
            tipo_usuario = None
        elif opcion_tipo == 2:
            tipo_usuario = "Estudiante"
        elif opcion_tipo == 3:
            tipo_usuario = "Profesor"
        elif opcion_tipo == 4:
            tipo_usuario = "Investigador"
        elif opcion_tipo == 5:
            tipo_usuario = "UsuarioPublico"
        
        print("\nüîç Incluir usuarios morosos?")
        print("1. S√≠, incluir morosos")
        print("2. No, excluir morosos")
        
        opcion_morosos = self.obtener_entrada("Seleccione opci√≥n", int)
        incluir_morosos = (opcion_morosos == 1)
        
        try:
            reporte = ReporteUsuarios(generado_por, tipo_usuario, incluir_morosos)
            self.reportes_generados.append(reporte)
            print(f"\n‚úÖ Reporte generado exitosamente!")
            reporte.visualizar()
        except Exception as e:
            print(f"‚ùå Error al generar reporte: {e}")
    
    def generar_reporte_financiero(self):
        print("\n" + "="*40)
        print("üí∞ GENERAR REPORTE FINANCIERO")
        print("="*40)
        
        generado_por = self.obtener_entrada("Generado por")
        
        print("\nüîç Seleccionar per√≠odo:")
        print("1. Diario")
        print("2. Semanal")
        print("3. Mensual")
        print("4. Anual")
        
        opcion = self.obtener_entrada("Seleccione per√≠odo", int)
        
        periodo = "mensual"
        if opcion == 1:
            periodo = "diario"
        elif opcion == 2:
            periodo = "semanal"
        elif opcion == 3:
            periodo = "mensual"
        elif opcion == 4:
            periodo = "anual"
        
        try:
            reporte = ReporteFinanciero(generado_por, periodo)
            self.reportes_generados.append(reporte)
            print(f"\n‚úÖ Reporte generado exitosamente!")
            reporte.visualizar()
        except Exception as e:
            print(f"‚ùå Error al generar reporte: {e}")
    
    def ver_reportes_generados(self):
        if not self.reportes_generados:
            print("\nüì≠ No hay reportes generados.")
            return
        
        print("\n" + "="*60)
        print("üìã REPORTES GENERADOS")
        print("="*60)
        
        for i, reporte in enumerate(self.reportes_generados, 1):
            print(f"{i}. {reporte.get_titulo_reporte()}")
            print(f"   Generado por: {reporte.get_generado_por()}")
            print(f"   Fecha: {reporte.obtener_fecha_generacion()}")
            print(f"   Tipo: {reporte.__class__.__name__}")
            print()
    
    def exportar_reporte(self):
        if not self.reportes_generados:
            print("\nüì≠ No hay reportes para exportar.")
            return
        
        self.ver_reportes_generados()
        
        try:
            opcion = self.obtener_entrada("\nüì§ Seleccione n√∫mero de reporte a exportar", int) - 1
            if 0 <= opcion < len(self.reportes_generados):
                reporte = self.reportes_generados[opcion]
                
                print("\nüìÅ Seleccionar formato de exportaci√≥n:")
                print("1. Texto plano (.txt)")
                print("2. JSON (.json)")
                print("3. CSV (.csv)")
                
                formato_opcion = self.obtener_entrada("Seleccione formato", int)
                
                formato = "texto"
                extension = ".txt"
                if formato_opcion == 1:
                    formato = "texto"
                    extension = ".txt"
                elif formato_opcion == 2:
                    formato = "json"
                    extension = ".json"
                elif formato_opcion == 3:
                    formato = "csv"
                    extension = ".csv"
                
                contenido = reporte.exportar_formato(formato)
                
                # Generar nombre de archivo
                nombre_base = reporte.get_titulo_reporte().lower().replace(" ", "_")
                fecha = datetime.now().strftime("%Y%m%d_%H%M%S")
                nombre_archivo = f"{nombre_base}_{fecha}{extension}"
                
                # Guardar en archivo
                with open(nombre_archivo, 'w', encoding='utf-8') as f:
                    f.write(contenido)
                
                print(f"\n‚úÖ Reporte exportado exitosamente!")
                print(f"   Archivo: {nombre_archivo}")
                print(f"   Tama√±o: {len(contenido)} caracteres")
                
                # Mostrar vista previa
                print(f"\nüìÑ Vista previa (primeras 10 l√≠neas):")
                print("-"*40)
                lineas = contenido.split('\n')[:10]
                for linea in lineas:
                    print(linea)
                if len(contenido.split('\n')) > 10:
                    print("...")
                
        except (ValueError, IndexError):
            print("‚ùå Opci√≥n inv√°lida")
        except Exception as e:
            print(f"‚ùå Error al exportar: {e}")
    
    def demostrar_polimorfismo(self):
        print("\n" + "="*60)
        print("üéØ DEMOSTRACI√ìN DE POLIMORFISMO")
        print("="*60)
        print("Mismo m√©todo generar_contenido(), diferentes estructuras:")
        print("-"*60)
        
        # Crear un reporte de cada tipo
        generado_por = "Sistema Demo"
        
        try:
            reportes = [
                ReportePrestamos(generado_por),
                ReporteMateriales(generado_por),
                ReporteUsuarios(generado_por),
                ReporteFinanciero(generado_por)
            ]
            
            for reporte in reportes:
                contenido = reporte.generar_contenido()
                print(f"\n{reporte.__class__.__name__}:")
                print(f"  Tipo de contenido: {type(contenido).__name__}")
                
                if isinstance(contenido, dict):
                    print(f"  Campos principales: {list(contenido.keys())[:3]}...")
                    if 'Detalles' in contenido:
                        print(f"  Cantidad de detalles: {len(contenido['Detalles'])}")
                else:
                    print(f"  Longitud: {len(str(contenido))} caracteres")
            
            print("\n" + "-"*60)
            print("Mismo m√©todo exportar_formato(), diferentes resultados:")
            print("-"*60)
            
            reporte = reportes[0]  # Usar el primero como ejemplo
            for formato in ["texto", "json", "csv"]:
                try:
                    exportado = reporte.exportar_formato(formato)
                    print(f"\n{formato.upper()}:")
                    print(f"  Tipo: {type(exportado).__name__}")
                    print(f"  Longitud: {len(exportado)} caracteres")
                except:
                    print(f"\n{formato.upper()}: No soportado")
                    
        except Exception as e:
            print(f"‚ùå Error en demostraci√≥n: {e}")
    
    def demostrar_encapsulamiento(self):
        print("\n" + "="*60)
        print("üîí DEMOSTRACI√ìN DE ENCAPSULAMIENTO")
        print("="*60)
        
        # Crear un reporte de ejemplo
        generado_por = "Demo"
        reporte = ReporteFinanciero(generado_por, "mensual")
        
        print("1. Intentando acceder a atributos privados directamente:")
        print("   reporte.__titulo_reporte ‚Üí Generar√° AttributeError")
        
        try:
            print(f"   Intento: {reporte.__titulo_reporte}")
        except AttributeError:
            print("   ‚úÖ CORRECTO: AttributeError al acceder a __titulo_reporte")
        
        print("\n2. Usando getters para acceso controlado:")
        print(f"   T√≠tulo: {reporte.get_titulo_reporte()}")
        print(f"   Generado por: {reporte.get_generado_por()}")
        print(f"   Fecha: {reporte.obtener_fecha_generacion()}")
        
        print("\n3. Datos protegidos (_datos):")
        contenido = reporte.generar_contenido()
        print(f"   Datos procesados: {len(contenido.get('Detalles', []))} elementos")
        print("   Solo accesibles a trav√©s de m√©todos controlados")
    
    def comparar_reportes(self):
        if len(self.reportes_generados) < 2:
            print("\nüì≠ Se necesitan al menos 2 reportes para comparar.")
            return
        
        print("\n" + "="*60)
        print("üìà COMPARACI√ìN DE REPORTES")
        print("="*60)
        
        print("üìã Reportes disponibles:")
        for i, reporte in enumerate(self.reportes_generados[-5:], 1):  # √öltimos 5
            print(f"{i}. {reporte.get_titulo_reporte()} ({reporte.__class__.__name__})")
        
        try:
            opcion1 = self.obtener_entrada("\nüîç Seleccione primer reporte", int) - 1
            opcion2 = self.obtener_entrada("Seleccione segundo reporte", int) - 1
            
            if (0 <= opcion1 < len(self.reportes_generados) and 
                0 <= opcion2 < len(self.reportes_generados)):
                
                reporte1 = self.reportes_generados[opcion1]
                reporte2 = self.reportes_generados[opcion2]
                
                print("\n" + "="*60)
                print("üîÑ COMPARANDO REPORTES")
                print("="*60)
                
                print(f"\nüìÑ REPORTE 1: {reporte1.get_titulo_reporte()}")
                print(f"   Tipo: {reporte1.__class__.__name__}")
                print(f"   Generado: {reporte1.obtener_fecha_generacion()}")
                
                print(f"\nüìÑ REPORTE 2: {reporte2.get_titulo_reporte()}")
                print(f"   Tipo: {reporte2.__class__.__name__}")
                print(f"   Generado: {reporte2.obtener_fecha_generacion()}")
                
                print("\n" + "-"*60)
                print("üìä DIFERENCIAS:")
                
                # Comparar tipos
                if reporte1.__class__ == reporte2.__class__:
                    print("‚úÖ Mismo tipo de reporte")
                else:
                    print("‚ö†Ô∏è  Diferentes tipos de reporte")
                    print(f"   {reporte1.__class__.__name__} vs {reporte2.__class__.__name__}")
                
                # Comparar fechas
                fecha1 = reporte1.get_fecha_generacion()
                fecha2 = reporte2.get_fecha_generacion()
                diferencia = abs((fecha1 - fecha2).total_seconds() / 3600)  # Horas
                
                print(f"‚è∞ Diferencia en tiempo: {diferencia:.1f} horas")
                
                # Generar y comparar contenidos brevemente
                try:
                    contenido1 = reporte1.generar_contenido()
                    contenido2 = reporte2.generar_contenido()
                    
                    if isinstance(contenido1, dict) and isinstance(contenido2, dict):
                        print(f"üì¶ Campos en com√∫n: {len(set(contenido1.keys()) & set(contenido2.keys()))}")
                        
                        # Buscar diferencias en valores clave
                        for key in ['Total', 'Total usuarios', 'Total materiales', 'Ingresos totales']:
                            if key in contenido1 and key in contenido2:
                                if contenido1[key] != contenido2[key]:
                                    print(f"üìù Diferencia en '{key}':")
                                    print(f"   Reporte 1: {contenido1[key]}")
                                    print(f"   Reporte 2: {contenido2[key]}")
                                    break
                        
                except:
                    print("‚ö†Ô∏è  No se pudieron comparar contenidos completos")
                
                print("\nüéØ CONCLUSI√ìN:")
                if reporte1.__class__ == reporte2.__class__:
                    print("   Estos reportes son del mismo tipo y pueden compararse directamente")
                else:
                    print("   Estos reportes son de tipos diferentes, muestran informaci√≥n complementaria")
                    
        except (ValueError, IndexError):
            print("‚ùå Opci√≥n inv√°lida")
        except Exception as e:
            print(f"‚ùå Error al comparar: {e}")
    
    def ejecutar(self):
        while True:
            self.mostrar_menu_principal()
            opcion = self.obtener_entrada("Seleccione una opci√≥n", int)
            
            if opcion == 0:
                print("\nüëã ¬°Gracias por usar el sistema de reportes!")
                break
            
            elif opcion == 1:
                self.generar_reporte_prestamos()
            
            elif opcion == 2:
                self.generar_reporte_materiales()
            
            elif opcion == 3:
                self.generar_reporte_usuarios()
            
            elif opcion == 4:
                self.generar_reporte_financiero()
            
            elif opcion == 5:
                self.ver_reportes_generados()
            
            elif opcion == 6:
                self.exportar_reporte()
            
            elif opcion == 7:
                self.demostrar_polimorfismo()
            
            elif opcion == 8:
                self.demostrar_encapsulamiento()
            
            elif opcion == 9:
                self.comparar_reportes()
            
            else:
                print("‚ùå Opci√≥n inv√°lida")
            
            if opcion != 0:
                input("\n‚èé Presione Enter para continuar...")

# ========== PROGRAMA PRINCIPAL ==========
if __name__ == "__main__":
    print("="*60)
    print("EJERCICIO 1.4: SISTEMA DE REPORTES Y ESTAD√çSTICAS")
    print("="*60)
    
    # Demostrar que no se puede instanciar clase abstracta
    print("\nüîç Demostrando ABSTRACCI√ìN:")
    try:
        # Intentar crear objeto de clase abstracta
        reporte = Reporte("Test", "Admin")
        print("‚ùå ERROR: No deber√≠a poder instanciarse")
    except NotImplementedError as e:
        print(f"‚úÖ CORRECTO: No se puede instanciar Reporte base")
        print(f"   Error: {e}")
    
    input("\n‚èé Presione Enter para iniciar el sistema interactivo...")
    
    # Iniciar men√∫ interactivo
    sistema = MenuReportes()
    sistema.ejecutar()
