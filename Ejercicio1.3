"""
EJERCICIO 1.3: SISTEMA DE PRESTAMOS Y DEVOLUCIONES
"""

import json
import os
from datetime import datetime, timedelta

class Transaccion:
    def __init__(self, id_transaccion, usuario, material):
        self.__id_transaccion = id_transaccion
        self.__fecha = datetime.now().isoformat()
        self.__usuario = usuario
        self.__material = material
        self._estado = "pendiente"
        self.__dias_retraso = 0
    
    def get_id_transaccion(self): return self.__id_transaccion
    def get_fecha(self): return self.__fecha
    def get_usuario(self): return self.__usuario
    def get_material(self): return self.__material
    def get_estado(self): return self._estado
    
    def set_estado(self, valor):
        if valor not in ["pendiente", "aprobada", "rechazada", "completada"]:
            raise ValueError("Estado invÃ¡lido")
        self._estado = valor
    
    def procesar_transaccion(self): raise NotImplementedError("Abstracto")
    def calcular_costo(self): raise NotImplementedError("Abstracto")
    
    def __calcular_multa(self): return 0.50 * self.__dias_retraso
    
    def set_dias_retraso(self, fecha_limite, fecha_real):
        if isinstance(fecha_limite, str): fecha_limite = datetime.fromisoformat(fecha_limite)
        if isinstance(fecha_real, str): fecha_real = datetime.fromisoformat(fecha_real)
        if fecha_real > fecha_limite:
            self.__dias_retraso = (fecha_real - fecha_limite).days
    
    def to_dict(self):
        return {
            'id': self.__id_transaccion,
            'fecha': self.__fecha,
            'usuario': self.__usuario.get_nombre() if hasattr(self.__usuario, 'get_nombre') else str(self.__usuario),
            'material': self.__material.get_titulo() if hasattr(self.__material, 'get_titulo') else str(self.__material),
            'estado': self._estado,
            'tipo': self.__class__.__name__
        }
    
    def __str__(self): return f"TransacciÃ³n {self.__id_transaccion} - {self._estado}"

class Prestamo(Transaccion):
    def __init__(self, id_transaccion, usuario, material, fecha_inicio, fecha_limite):
        super().__init__(id_transaccion, usuario, material)
        self.__fecha_inicio = fecha_inicio
        self.__fecha_limite = fecha_limite
        self.__fecha_devolucion_real = None
    
    def procesar_transaccion(self):
        self.set_estado("aprobada")
        return f"PrÃ©stamo aprobado. Devolver antes del {self.__fecha_limite.strftime('%d/%m/%Y')}"
    
    def calcular_costo(self):
        if self.__fecha_devolucion_real:
            dias = (self.__fecha_devolucion_real - self.__fecha_inicio).days
            costo = 2.00 * dias
            multa = self._Transaccion__calcular_multa()
            return costo + multa
        return 0.0
    
    def set_fecha_devolucion_real(self, fecha):
        if isinstance(fecha, str): fecha = datetime.fromisoformat(fecha)
        self.__fecha_devolucion_real = fecha
        super().set_dias_retraso(self.__fecha_limite, fecha)
    
    def to_dict(self):
        data = super().to_dict()
        data.update({
            'fecha_inicio': self.__fecha_inicio.isoformat(),
            'fecha_limite': self.__fecha_limite.isoformat(),
            'fecha_devolucion': self.__fecha_devolucion_real.isoformat() if self.__fecha_devolucion_real else None,
            'dias_retraso': self._Transaccion__dias_retraso
        })
        return data
    
    def __str__(self):
        base = super().__str__()
        return f"{base} | PrÃ©stamo | Devuelto" if self.__fecha_devolucion_real else f"{base} | PrÃ©stamo | Activo"

class Reserva(Transaccion):
    def __init__(self, id_transaccion, usuario, material, fecha_reserva):
        super().__init__(id_transaccion, usuario, material)
        self.__fecha_reserva = fecha_reserva
        self.__fecha_retiro_estimada = fecha_reserva + timedelta(days=2)
    
    def procesar_transaccion(self):
        self.set_estado("aprobada")
        return f"Reserva aprobada. Retirar antes del {self.__fecha_retiro_estimada.strftime('%d/%m/%Y')}"
    
    def calcular_costo(self): return 0.0
    
    def to_dict(self):
        data = super().to_dict()
        data.update({
            'fecha_reserva': self.__fecha_reserva.isoformat(),
            'fecha_retiro': self.__fecha_retiro_estimada.isoformat()
        })
        return data
    
    def __str__(self): return f"{super().__str__()} | Reserva"

class Renovacion(Transaccion):
    def __init__(self, id_transaccion, usuario, material, prestamo_original):
        super().__init__(id_transaccion, usuario, material)
        self.__prestamo_original = prestamo_original
        self.__nueva_fecha_limite = prestamo_original._Prestamo__fecha_limite + timedelta(days=7)
    
    def procesar_transaccion(self):
        self.set_estado("aprobada")
        return f"RenovaciÃ³n aprobada. Nueva fecha: {self.__nueva_fecha_limite.strftime('%d/%m/%Y')}"
    
    def calcular_costo(self): return 1.00  # 50% descuento del costo base 2.00
    
    def to_dict(self):
        data = super().to_dict()
        data.update({
            'prestamo_original': self.__prestamo_original.get_id_transaccion(),
            'nueva_fecha': self.__nueva_fecha_limite.isoformat()
        })
        return data
    
    def __str__(self): return f"{super().__str__()} | RenovaciÃ³n"

class Devolucion(Transaccion):
    def __init__(self, id_transaccion, usuario, material, prestamo_asociado):
        super().__init__(id_transaccion, usuario, material)
        self.__prestamo_asociado = prestamo_asociado
        self.__fecha_devolucion = datetime.now()
        self.__estado_material = "bueno"
        self.__tiene_multa = False
    
    def procesar_transaccion(self):
        self.set_estado("completada")
        if self._Transaccion__dias_retraso > 0:
            self.__tiene_multa = True
            return f"DevoluciÃ³n con retraso de {self._Transaccion__dias_retraso} dÃ­as"
        return "DevoluciÃ³n a tiempo"
    
    def calcular_costo(self):
        if self.__tiene_multa:
            return self._Transaccion__calcular_multa()
        return 0.0
    
    def to_dict(self):
        data = super().to_dict()
        data.update({
            'prestamo_asociado': self.__prestamo_asociado.get_id_transaccion(),
            'fecha_devolucion': self.__fecha_devolucion.isoformat(),
            'estado_material': self.__estado_material,
            'tiene_multa': self.__tiene_multa
        })
        return data
    
    def __str__(self):
        base = super().__str__()
        multa = "CON MULTA" if self.__tiene_multa else "sin multa"
        return f"{base} | DevoluciÃ³n | {multa}"

class UsuarioSimulado:
    def __init__(self, nombre, id): self.__nombre = nombre; self.__id = id
    def get_nombre(self): return self.__nombre
    def get_id(self): return self.__id
    def __str__(self): return f"{self.__id} - {self.__nombre}"

class MaterialSimulado:
    def __init__(self, titulo, codigo): self.__titulo = titulo; self.__codigo = codigo
    def get_titulo(self): return self.__titulo
    def get_codigo_unico(self): return self.__codigo
    def __str__(self): return f"{self.__codigo} - {self.__titulo}"

class JSONStorage:
    def __init__(self, file_path="data_transacciones.json"): self.file_path = file_path
    
    def load_transacciones(self):
        if not os.path.exists(self.file_path): return []
        try:
            with open(self.file_path, 'r', encoding='utf-8') as file:
                data = json.load(file)
                transacciones = []
                usuarios = {}
                materiales = {}
                
                for item in data:
                    usuario = UsuarioSimulado(item['usuario'], "U001")
                    material = MaterialSimulado(item['material'], "M001")
                    
                    if item['tipo'] == "Prestamo":
                        t = Prestamo(
                            item['id'], usuario, material,
                            datetime.fromisoformat(item['fecha_inicio']),
                            datetime.fromisoformat(item['fecha_limite'])
                        )
                        if item['fecha_devolucion']:
                            t.set_fecha_devolucion_real(item['fecha_devolucion'])
                    elif item['tipo'] == "Reserva":
                        t = Reserva(
                            item['id'], usuario, material,
                            datetime.fromisoformat(item['fecha_reserva'])
                        )
                    elif item['tipo'] == "Renovacion":
                        # Para simplificar, creamos un prÃ©stamo dummy
                        prestamo_dummy = Prestamo(
                            item['prestamo_original'], usuario, material,
                            datetime.now(), datetime.now()
                        )
                        t = Renovacion(item['id'], usuario, material, prestamo_dummy)
                    elif item['tipo'] == "Devolucion":
                        prestamo_dummy = Prestamo(
                            item['prestamo_asociado'], usuario, material,
                            datetime.now(), datetime.now()
                        )
                        t = Devolucion(item['id'], usuario, material, prestamo_dummy)
                    else: continue
                    
                    t.set_estado(item['estado'])
                    transacciones.append(t)
                
                print(f"ğŸ“‚ Cargadas {len(transacciones)} transacciones")
                return transacciones
        except: return []
    
    def save_transacciones(self, transacciones):
        try:
            data = [t.to_dict() for t in transacciones]
            with open(self.file_path, 'w', encoding='utf-8') as file:
                json.dump(data, file, indent=2, ensure_ascii=False)
            print(f"ğŸ’¾ Guardadas {len(transacciones)} transacciones")
            return True
        except: return False

class TransaccionService:
    def __init__(self):
        self.storage = JSONStorage()
        self.transacciones = self.storage.load_transacciones()
        self.next_id = len(self.transacciones) + 1
    
    def crear_reserva(self, usuario, material):
        id = f"R{self.next_id:03d}"
        reserva = Reserva(id, usuario, material, datetime.now())
        self.transacciones.append(reserva)
        self.next_id += 1
        if self.storage.save_transacciones(self.transacciones):
            return reserva
        return None
    
    def crear_prestamo(self, usuario, material, dias=7):
        id = f"P{self.next_id:03d}"
        fecha_inicio = datetime.now()
        fecha_limite = fecha_inicio + timedelta(days=dias)
        prestamo = Prestamo(id, usuario, material, fecha_inicio, fecha_limite)
        self.transacciones.append(prestamo)
        self.next_id += 1
        if self.storage.save_transacciones(self.transacciones):
            return prestamo
        return None
    
    def crear_devolucion(self, usuario, material, prestamo):
        id = f"D{self.next_id:03d}"
        devolucion = Devolucion(id, usuario, material, prestamo)
        # Simular retraso para demostraciÃ³n
        fecha_limite = prestamo._Prestamo__fecha_limite
        fecha_real = fecha_limite + timedelta(days=3)  # 3 dÃ­as de retraso
        devolucion.set_dias_retraso(fecha_limite, fecha_real)
        
        self.transacciones.append(devolucion)
        self.next_id += 1
        if self.storage.save_transacciones(self.transacciones):
            return devolucion
        return None
    
    def crear_renovacion(self, usuario, material, prestamo):
        id = f"N{self.next_id:03d}"
        renovacion = Renovacion(id, usuario, material, prestamo)
        self.transacciones.append(renovacion)
        self.next_id += 1
        if self.storage.save_transacciones(self.transacciones):
            return renovacion
        return None
    
    def obtener_todas(self): return self.transacciones
    
    def obtener_por_tipo(self, tipo):
        return [t for t in self.transacciones if t.__class__.__name__.lower() == tipo.lower()]

class TransaccionMenu:
    def __init__(self):
        self.service = TransaccionService()
        self.usuario = UsuarioSimulado("Ana LÃ³pez", "U001")
        self.material = MaterialSimulado("Cien AÃ±os de Soledad", "LF001")
    
    def mostrar_menu(self):
        print("\n" + "="*50)
        print("ğŸ”„ SISTEMA DE PRÃ‰STAMOS Y DEVOLUCIONES")
        print("="*50)
        print("1. Simular ciclo completo")
        print("2. Ver todas las transacciones")
        print("3. Calcular costos")
        print("4. Demostrar multas por retraso")
        print("5. Demostrar polimorfismo")
        print("6. Demostrar encapsulamiento")
        print("7. Verificar clase abstracta")
        print("0. Salir")
        print("-"*50)
    
    def get_input(self, prompt, tipo=str):
        while True:
            try:
                valor = input(prompt).strip()
                if tipo == int: return int(valor)
                return valor
            except: print("âŒ Valor invÃ¡lido")
    
    def simular_ciclo(self):
        print("\nğŸ”„ SIMULANDO CICLO COMPLETO:")
        print("-"*40)
        
        # 1. Reserva
        print("\n1. CREANDO RESERVA...")
        reserva = self.service.crear_reserva(self.usuario, self.material)
        if reserva:
            resultado = reserva.procesar_transaccion()
            print(f"   âœ… {resultado}")
        
        # 2. PrÃ©stamo
        print("\n2. CREANDO PRÃ‰STAMO...")
        prestamo = self.service.crear_prestamo(self.usuario, self.material, 7)
        if prestamo:
            resultado = prestamo.procesar_transaccion()
            print(f"   âœ… {resultado}")
        
        # 3. DevoluciÃ³n con retraso
        print("\n3. CREANDO DEVOLUCIÃ“N (con retraso)...")
        if prestamo:
            # Simular devoluciÃ³n con 3 dÃ­as de retraso
            fecha_limite = prestamo._Prestamo__fecha_limite
            fecha_real = fecha_limite + timedelta(days=3)
            prestamo.set_fecha_devolucion_real(fecha_real)
            
            devolucion = self.service.crear_devolucion(self.usuario, self.material, prestamo)
            if devolucion:
                resultado = devolucion.procesar_transaccion()
                print(f"   âœ… {resultado}")
                costo = devolucion.calcular_costo()
                if costo > 0:
                    print(f"   ğŸ’° Multa por retraso: ${costo:.2f}")
        
        # 4. RenovaciÃ³n
        print("\n4. CREANDO RENOVACIÃ“N...")
        if prestamo:
            renovacion = self.service.crear_renovacion(self.usuario, self.material, prestamo)
            if renovacion:
                resultado = renovacion.procesar_transaccion()
                print(f"   âœ… {resultado}")
                costo = renovacion.calcular_costo()
                print(f"   ğŸ’° Costo renovaciÃ³n: ${costo:.2f}")
        
        print("\nâœ… Ciclo completado exitosamente")
    
    def ver_transacciones(self):
        transacciones = self.service.obtener_todas()
        if not transacciones: print("âŒ No hay transacciones"); return
        
        print("\nğŸ“‹ TRANSACCIONES:")
        for t in transacciones:
            print(f"  {t}")
        print(f"ğŸ“Š Total: {len(transacciones)}")
    
    def calcular_costos(self):
        transacciones = self.service.obtener_todas()
        if not transacciones: print("âŒ No hay transacciones"); return
        
        print("\nğŸ’° COSTOS DE TRANSACCIONES:")
        print("-"*40)
        total = 0
        for t in transacciones:
            costo = t.calcular_costo()
            total += costo
            print(f"  {t.get_id_transaccion():<6} {t.__class__.__name__:<12} ${costo:.2f}")
        print(f"  {'TOTAL':<18} ${total:.2f}")
    
    def demostrar_multas(self):
        print("\nâš ï¸ DEMOSTRACIÃ“N DE MULTA POR RETRASO")
        print("-"*40)
        
        # Crear prÃ©stamo de ejemplo
        fecha_inicio = datetime.now()
        fecha_limite = fecha_inicio + timedelta(days=7)
        prestamo = Prestamo("TEST001", self.usuario, self.material, fecha_inicio, fecha_limite)
        
        # Simular devoluciÃ³n con 5 dÃ­as de retraso
        fecha_real = fecha_limite + timedelta(days=5)
        prestamo.set_fecha_devolucion_real(fecha_real)
        
        print(f"ğŸ“… Fecha lÃ­mite: {fecha_limite.strftime('%d/%m/%Y')}")
        print(f"ğŸ“… Fecha devoluciÃ³n real: {fecha_real.strftime('%d/%m/%Y')}")
        print(f"â° DÃ­as de retraso: {prestamo._Transaccion__dias_retraso}")
        
        multa = prestamo._Transaccion__calcular_multa()
        print(f"ğŸ’° Multa calculada: ${multa:.2f}")
        print(f"   (${0.50:.2f} por dÃ­a Ã— {prestamo._Transaccion__dias_retraso} dÃ­as)")
    
    def demostrar_polimorfismo(self):
        print("\nğŸ¯ DEMOSTRACIÃ“N DE POLIMORFISMO")
        print("-"*40)
        
        transacciones = [
            Reserva("T001", self.usuario, self.material, datetime.now()),
            Prestamo("T002", self.usuario, self.material, datetime.now(), datetime.now() + timedelta(days=7)),
            Devolucion("T003", self.usuario, self.material, None),
            Renovacion("T004", self.usuario, self.material, None)
        ]
        
        print("ğŸ“‹ Transacciones creadas:")
        for t in transacciones:
            print(f"  {t.__class__.__name__}: {t}")
        
        print("\nğŸ”„ Procesando transacciones:")
        for t in transacciones:
            resultado = t.procesar_transaccion()
            print(f"  {t.__class__.__name__:<12} â†’ {resultado}")
        
        print("\nğŸ’° Calculando costos:")
        for t in transacciones:
            costo = t.calcular_costo()
            print(f"  {t.__class__.__name__:<12} â†’ ${costo:.2f}")
        
        print("\nâœ… Polimorfismo demostrado")
    
    def demostrar_encapsulamiento(self):
        print("\nğŸ”’ DEMOSTRACIÃ“N DE ENCAPSULAMIENTO")
        print("-"*40)
        
        prestamo = Prestamo("TEST", self.usuario, self.material, datetime.now(), datetime.now() + timedelta(days=7))
        
        print("âœ… Acceso mediante mÃ©todos pÃºblicos:")
        print(f"  ID: {prestamo.get_id_transaccion()}")
        print(f"  Estado: {prestamo.get_estado()}")
        
        print("\nâœ… ValidaciÃ³n en setter:")
        try: prestamo.set_estado("estado_invalido")
        except ValueError as e: print(f"  âœ… Correcto: {e}")
        
        print("\nâŒ Intentando acceso a mÃ©todo privado:")
        try: multa = prestamo.__calcular_multa()
        except AttributeError: print("  âœ… Correcto: MÃ©todo privado no accesible")
    
    def verificar_clase_abstracta(self):
        print("\nâš ï¸ VERIFICANDO CLASE ABSTRACTA")
        print("-"*40)
        try: trans = Transaccion("TEST", self.usuario, self.material)
        except (TypeError, NotImplementedError) as e: print(f"âœ… Correcto: {e}")
    
    def run(self):
        print("ğŸš€ INICIANDO SISTEMA DE TRANSACCIONES...")
        while True:
            self.mostrar_menu()
            opcion = self.get_input("OpciÃ³n: ", str)
            if opcion == "0": print("ğŸ‘‹ Â¡AdiÃ³s!"); break
            elif opcion == "1": self.simular_ciclo()
            elif opcion == "2": self.ver_transacciones()
            elif opcion == "3": self.calcular_costos()
            elif opcion == "4": self.demostrar_multas()
            elif opcion == "5": self.demostrar_polimorfismo()
            elif opcion == "6": self.demostrar_encapsulamiento()
            elif opcion == "7": self.verificar_clase_abstracta()
            else: print("âŒ OpciÃ³n invÃ¡lida")
            if opcion != "0": input("\nâ Presiona Enter...")

menu = TransaccionMenu()
menu.run()
